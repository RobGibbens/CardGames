@using CardGames.Poker.Api.Contracts
@using CardGames.Core.French.Cards
@using CardGames.Poker.Evaluation
@using CardGames.Poker.Hands
@using CardGames.Poker.Hands.DrawHands
@using CardGames.Poker.Hands.StudHands

@using System.Globalization

<div class="table-overlay showdown-overlay" role="dialog" aria-modal="true" aria-label="Showdown results">
    <div class="overlay-content showdown-content @(ShowdownWon ? "showdown-won" : "")">
        <button type="button" class="showdown-close" @onclick="OnClose" aria-label="Close showdown">
            &times;
        </button>

        <header class="showdown-header">
            <div class="showdown-icon" aria-hidden="true">
                <i class="fa-solid fa-trophy"></i>
            </div>
            <div class="showdown-heading">
                <h2 class="showdown-title">Showdown</h2>
                <div class="showdown-subtitle">@GetOutcomeSubtitle()</div>
            </div>
        </header>

        @if (ShowdownResult is null)
        {
            <p class="showdown-empty">No showdown data.</p>
        }
        else
        {
            var winnerHand = GetPrimaryWinnerHand(ShowdownResult);
            var otherHands = GetLoserHands(ShowdownResult, winnerHand);
            var winnerCards = winnerHand is not null ? GetDisplayCards(winnerHand) : [];
            var winnerName = GetWinnerDisplayName(ShowdownResult, winnerHand);
            var winnerDescription = GetWinnerDescription(ShowdownResult, winnerHand);
            var winnerAmount = GetWinnerAmount(ShowdownResult, winnerHand);
            var winnerVerb = GetWinnerVerb(ShowdownResult, winnerHand);

            <section class="showdown-winner" aria-label="Winner">
                <div class="winner-banner @(ShowdownWon ? "winner-banner-celebrate" : "")">
                    @if (ShowdownWon)
                    {
                        <div class="winner-celebration" aria-hidden="true">
                            <span class="winner-ribbon">Winner</span>
                            <i class="fa-solid fa-sparkles celebration-star celebration-star-left"></i>
                            <i class="fa-solid fa-sparkles celebration-star celebration-star-right"></i>
                            @for (var i = 0; i < 14; i++)
                            {
                                <span class="celebration-confetti" style="--i:@i"></span>
                            }
                        </div>
                    }

                    <div class="winner-headline">
                        @if (ShowdownWon)
                        {
                            <span class="winner-crown" aria-hidden="true"><i class="fa-solid fa-crown"></i></span>
                        }
                        <h3 class="winner-first">@winnerName</h3>
                        <span class="winner-rest">@winnerVerb</span>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(winnerDescription) || winnerAmount > 0)
                    {
                        <div class="winner-pills">
                            @if (!string.IsNullOrWhiteSpace(winnerDescription))
                            {
                                <span class="sd-pill sd-pill-muted">@winnerDescription</span>
                            }
                            @if (winnerAmount > 0)
                            {
                                <span class="sd-pill sd-pill-gold">+@winnerAmount chips</span>
                            }
                        </div>
                    }

                    @if (winnerCards.Count > 0)
                    {
                        <div class="showdown-cards winner-cards" aria-label="Winning cards">
                            @for (var i = 0; i < winnerCards.Count; i++)
                            {
                                var card = winnerCards[i];
                                <div class="sd-card-wrapper" style="--i:@i">
                                    <playing-card class="showdown-card showdown-card-winner" rank="@GetPlayingCardRank(card)" suit="@GetPlayingCardSuit(card)"></playing-card>
                                </div>
                            }
                        </div>
                    }
                </div>
            </section>

            @if (otherHands.Count > 0)
            {
                <section class="showdown-others" aria-label="Other hands">
                    <h3 class="showdown-section-title">Other Hands</h3>
                    @foreach (var hand in otherHands)
                    {
                        var handCards = GetDisplayCards(hand);
                        <div class="other-hand-row">
                            <div class="other-hand-info">
                                <span class="other-hand-name">@DisplayFirstName(hand)</span>
                                @if (!string.IsNullOrWhiteSpace(hand.HandType) || !string.IsNullOrWhiteSpace(hand.HandDescription))
                                {
                                    <span class="sd-pill sd-pill-muted">@GetDetailedHandDescription(hand)</span>
                                }
                                @if (hand.AmountWon.GetValueOrDefault() > 0)
                                {
                                    <span class="sd-pill sd-pill-gold">+@hand.AmountWon.GetValueOrDefault() chips</span>
                                }
                            </div>
                            @if (handCards.Count > 0)
                            {
                                <div class="showdown-cards other-cards">
                                    @foreach (var c in handCards)
                                    {
                                        <div>
                                            <playing-card class="showdown-card showdown-card-loser" rank="@GetPlayingCardRank(c)" suit="@GetPlayingCardSuit(c)"></playing-card>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </section>
            }
        }

        <div class="showdown-countdown">
            @if (IsGameEnded)
            {
                <p class="showdown-hint">Returning to lobby in <strong>@SecondsUntilNextHand</strong> seconds...</p>
            }
            else if (SecondsUntilNextHand > 0)
            {
                <p class="showdown-hint">Next hand starts in <strong>@SecondsUntilNextHand</strong> seconds...</p>
            }
            else
            {
                <p class="showdown-hint">Starting next hand...</p>
            }
        </div>
    </div>
</div>

@code {
            [Parameter]
            public PerformShowdownSuccessful? ShowdownResult { get; set; }

            [Parameter]
            public bool ShowdownWon { get; set; }

            [Parameter]
            public bool ShowdownLost { get; set; }

            [Parameter]
            public int SecondsUntilNextHand { get; set; }

            [Parameter]
            public bool IsGameEnded { get; set; }

            [Parameter]
            public EventCallback OnClose { get; set; }

    private static ShowdownPlayerHand? GetPrimaryWinnerHand(PerformShowdownSuccessful result)
    {
        if (result.PlayerHands is null || result.PlayerHands.Count == 0)
        {
            return null;
        }

        return result.PlayerHands
            .Where(h => h is not null)
            .Select(h => EnrichHand(h, result.Payouts))
            .OrderByDescending(h => h.IsWinner == true)
            .ThenByDescending(h => h.AmountWon ?? 0)
            .ThenByDescending(h => h.HandStrength ?? 0)
            .FirstOrDefault();
    }

    private static List<ShowdownPlayerHand> GetLoserHands(PerformShowdownSuccessful result, ShowdownPlayerHand? winner)
    {
        if (result.PlayerHands is null)
        {
            return [];
        }

        var hands = result.PlayerHands
            .Where(h => h is not null)
            .Select(h => EnrichHand(h, result.Payouts))
            .ToList();

        if (winner is not null)
        {
            var toRemove = hands.FirstOrDefault(h => h.PlayerName == winner.PlayerName);
            if (toRemove is not null)
            {
                hands.Remove(toRemove);
            }

            hands = hands.Where(h => h.IsWinner != true).ToList();
        }
        else
        {
            hands = hands.Where(h => h.IsWinner != true).ToList();
        }

        return hands
            .OrderByDescending(h => h.AmountWon ?? 0)
            .ThenBy(h => h.PlayerName)
            .ToList();
    }

    private static string GetWinnerDisplayName(PerformShowdownSuccessful result, ShowdownPlayerHand? winnerHand)
    {
        if (winnerHand is not null)
        {
            return DisplayFirstName(winnerHand);
        }

        if (result.Payouts is not null && result.Payouts.Count > 0)
        {
            var winnerName = result.Payouts.First().Key;
            if (!string.IsNullOrWhiteSpace(winnerName))
            {
                var parts = winnerName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
                return parts.Length > 0 ? parts[0] : winnerName;
            }
        }

        return "Winner";
    }

    private static int GetWinnerAmount(PerformShowdownSuccessful result, ShowdownPlayerHand? winnerHand)
    {
        if (winnerHand?.AmountWon is > 0)
        {
            return winnerHand.AmountWon.Value;
        }

        if (result.Payouts is not null && result.Payouts.Count > 0)
        {
            return result.Payouts.First().Value;
        }

        return 0;
    }

    private static string GetWinnerDescription(PerformShowdownSuccessful result, ShowdownPlayerHand? winnerHand)
    {
        if (winnerHand is not null)
        {
            return GetDetailedHandDescription(winnerHand);
        }

        return result.WonByFold == true ? "Won by fold" : string.Empty;
    }

    private static string GetWinnerVerb(PerformShowdownSuccessful result, ShowdownPlayerHand? winnerHand)
    {
        if (result.WonByFold == true)
        {
            return "wins by fold";
        }

        if (IsDeckHand(winnerHand))
        {
            return "wins this hand";
        }

        return "wins the hand";
    }

    private static bool IsDeckHand(ShowdownPlayerHand? hand)
    {
        return string.Equals(hand?.PlayerName, "The Deck", StringComparison.OrdinalIgnoreCase);
    }

    private static ShowdownPlayerHand EnrichHand(ShowdownPlayerHand hand, IDictionary<string, int>? payouts)
    {
        if (payouts is not null && payouts.TryGetValue(hand.PlayerName, out var amount))
        {
            // Always prefer the value in Payouts if it's larger (or if AmountWon is missing/zero)
            var current = hand.AmountWon ?? 0;
            if (amount > current)
            {
                return hand with { AmountWon = amount };
            }
        }
        return hand;
    }

    /// <summary>
    /// Gets the cards to display for a player's hand.
    /// For Seven Card Stud (7 cards), returns only the best 5 cards.
    /// Uses BestCardIndexes if provided by API, otherwise computes client-side.
    /// For other games, returns all cards sorted by symbol.
    /// </summary>
    private static List<ShowdownCard> GetDisplayCards(ShowdownPlayerHand hand)
    {
        if (hand.Cards is null || hand.Cards.Count == 0)
        {
            return [];
        }

        var cardsList = hand.Cards.ToList();

        // If BestCardIndexes is provided and valid, use only those cards
        if (hand.BestCardIndexes is not null && hand.BestCardIndexes.Count == 5)
        {
            return hand.BestCardIndexes
                .Where(idx => idx >= 0 && idx < cardsList.Count)
                .Select(idx => cardsList[idx])
                .OrderBy(GetCardDisplayOrder)
                .ToList();
        }

        // For wild-card hands, show all cards to avoid incorrect best-5 selection client-side
        if (hand.WildCardIndexes is not null && hand.WildCardIndexes.Count > 0 && cardsList.Count > 5)
        {
            return cardsList.OrderBy(GetCardDisplayOrder).ToList();
        }

        // For 7-card hands (Seven Card Stud), compute best 5 cards client-side
        if (cardsList.Count == 7)
        {
            var coreCards = cardsList
                .Where(c => c is { Suit: not null, Symbol: not null })
                .Select(c => new Card(MapSuit(c.Suit!.Value), MapSymbol(c.Symbol!.Value)))
                .ToList();

            if (coreCards.Count == 7)
            {
                var studHand = new StudHand([], coreCards, []);
                var bestCards = studHand.GetBestHand();

                // Map back to ShowdownCards by matching suit and symbol
                // Use a list to track which cards have been used (to handle potential duplicates)
                var result = new List<ShowdownCard>();
                var usedIndexes = new HashSet<int>();

                foreach (var bc in bestCards)
                {
                    for (var i = 0; i < cardsList.Count; i++)
                    {
                        if (usedIndexes.Contains(i))
                        {
                            continue;
                        }

                        var sc = cardsList[i];
                        if (sc.Suit.HasValue && sc.Symbol.HasValue &&
                            MapSuit(sc.Suit.Value) == bc.Suit &&
                            MapSymbol(sc.Symbol.Value) == bc.Symbol)
                        {
                            result.Add(sc);
                            usedIndexes.Add(i);
                            break;
                        }
                    }
                }

                return result.OrderBy(c => c.Symbol).ToList();
            }
        }

        // Fall back to showing all cards (for 5-card games)
        return cardsList.OrderBy(c => c.Symbol).ToList();
    }

    private string? GetPlayingCardSuit(ShowdownCard card)
    {
        var suit = card.Suit switch
        {
            CardSuit.Hearts => "Hearts",
            CardSuit.Diamonds => "Diamonds",
            CardSuit.Clubs => "Clubs",
            CardSuit.Spades => "Spades",
            _ => ""
        };
        return suit;
    }

    private string? GetPlayingCardRank(ShowdownCard card)
    {
        var rank = card.Symbol switch
        {
            CardSymbol.Ace => "Ace",
            CardSymbol.Deuce => "2",
            CardSymbol.Three => "3",
            CardSymbol.Four => "4",
            CardSymbol.Five => "5",
            CardSymbol.Six => "6",
            CardSymbol.Seven => "7",
            CardSymbol.Eight => "8",
            CardSymbol.Nine => "9",
            CardSymbol.Ten => "10",
            CardSymbol.Jack => "Jack",
            CardSymbol.Queen => "Queen",
            CardSymbol.King => "King",
            _ => ""
        };

        return rank;
    }
    private string GetOutcomeSubtitle()
    {
        // Handle player-vs-deck scenario first
        if (IsPlayerVsDeckScenario())
        {
            var playerHand = GetPlayerHand();
            var playerWon = playerHand?.IsWinner == true;
            if (IsGameEnded && playerWon)
            {
                return "You beat the deck! Game Over";
            }
            return playerWon ? "You beat the deck!" : "The deck wins this round";
        }

        if (ShowdownResult?.WonByFold == true)
        {
            return "Everyone folded";
        }

        if (ShowdownWon)
        {
            return IsGameEnded ? "You won the game!" : "You won the hand";
        }

        if (ShowdownLost)
        {
            return IsGameEnded ? "Game Over" : "Hand complete";
        }

        return "Results are in";
    }

    private static string DisplayFirstName(ShowdownPlayerHand? hand)
    {
        if (!string.IsNullOrWhiteSpace(hand?.PlayerFirstName))
        {
            return hand.PlayerFirstName;
        }

        if (string.IsNullOrWhiteSpace(hand?.PlayerName))
        {
            return "Player";
        }

        var parts = hand.PlayerName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length > 0 ? parts[0] : hand.PlayerName;
    }

    private static string HumanizeHandType(string? handType)
    {
        if (string.IsNullOrWhiteSpace(handType))
        {
            return "";
        }

        // Handles values like "FullHouse", "TwoPair", "HighCard".
        var s = handType.Trim();
        s = System.Text.RegularExpressions.Regex.Replace(s, "([a-z])([A-Z])", "$1 $2");
        s = System.Text.RegularExpressions.Regex.Replace(s, "([A-Z])([A-Z][a-z])", "$1 $2");
        return CultureInfo.InvariantCulture.TextInfo.ToTitleCase(s);
    }

    private static string GetSuitColorClass(CardSuit? suit)
    {
        return suit switch
        {
            CardSuit.Hearts or CardSuit.Diamonds => "suit-red",
            _ => "suit-black"
        };
    }

    private static int GetCardDisplayOrder(ShowdownCard card)
    {
        var symbolValue = card.Symbol.HasValue ? (int)card.Symbol.Value : 0;
        var suitValue = card.Suit.HasValue ? (int)card.Suit.Value : 0;
        return symbolValue * 10 + suitValue;
    }

    private static string GetDetailedHandDescription(ShowdownPlayerHand hand)
    {
        // Prefer server-provided hand description (already handles wild cards)
        if (!string.IsNullOrWhiteSpace(hand.HandDescription))
        {
            return hand.HandDescription;
        }

        if (hand.Cards is null || hand.Cards.Count < 5)
        {
            return HumanizeHandType(hand.HandType);
        }

        var coreCards = hand.Cards
            .Where(c => c is { Suit: not null, Symbol: not null })
            .Select(c => new Card(MapSuit(c.Suit!.Value), MapSymbol(c.Symbol!.Value)))
            .ToList();

        if (coreCards.Count < 5)
        {
            return HumanizeHandType(hand.HandType);
        }

        // If the server did not provide a description, do not try to infer variant rules from card faces.
        // (A Five Card Draw hand can contain 2s/Jacks/Kd too.)
        // For hands with more than 5 cards (e.g., Seven Card Stud with 7), use StudHand to find the best 5-card combination.
        HandBase evaluatedHand = coreCards.Count == 5
            ? new DrawHand(coreCards)
            : new StudHand([], coreCards, []);

        return HandDescriptionFormatter.GetHandDescription(evaluatedHand);
    }

    private static Suit MapSuit(CardSuit suit) => suit switch
    {
        CardSuit.Hearts => Suit.Hearts,
        CardSuit.Diamonds => Suit.Diamonds,
        CardSuit.Spades => Suit.Spades,
        CardSuit.Clubs => Suit.Clubs,
        _ => throw new ArgumentOutOfRangeException(nameof(suit), suit, "Unknown suit")
    };

    private static Symbol MapSymbol(CardSymbol symbol) => symbol switch
    {
        CardSymbol.Deuce => Symbol.Deuce,
        CardSymbol.Three => Symbol.Three,
        CardSymbol.Four => Symbol.Four,
        CardSymbol.Five => Symbol.Five,
        CardSymbol.Six => Symbol.Six,
        CardSymbol.Seven => Symbol.Seven,
        CardSymbol.Eight => Symbol.Eight,
        CardSymbol.Nine => Symbol.Nine,
        CardSymbol.Ten => Symbol.Ten,
        CardSymbol.Jack => Symbol.Jack,
        CardSymbol.Queen => Symbol.Queen,
        CardSymbol.King => Symbol.King,
        CardSymbol.Ace => Symbol.Ace,
        _ => throw new ArgumentOutOfRangeException(nameof(symbol), symbol, "Unknown symbol")
    };

        private static string GetSuitFaIcon(CardSuit? suit)
        {
            return suit switch
            {
                CardSuit.Hearts => "fa-heart",
                CardSuit.Diamonds => "fa-diamond",
                CardSuit.Clubs => "fa-club",
                CardSuit.Spades => "fa-spade",
                _ => "fa-question"
            };
        }

        private static string GetRankLabel(CardSymbol? symbol)
        {
            return symbol switch
            {
                CardSymbol.Deuce => "2",
                CardSymbol.Three => "3",
                CardSymbol.Four => "4",
                CardSymbol.Five => "5",
                CardSymbol.Six => "6",
                CardSymbol.Seven => "7",
                CardSymbol.Eight => "8",
                CardSymbol.Nine => "9",
                CardSymbol.Ten => "10",
                CardSymbol.Jack => "J",
                CardSymbol.Queen => "Q",
                CardSymbol.King => "K",
                CardSymbol.Ace => "A",
                _ => "?"
            };
        }

        /// <summary>
        /// Detects if this is a player-vs-deck scenario (Kings and Lows).
        /// Identified by having "The Deck" as one of the player hands.
        /// </summary>
        private bool IsPlayerVsDeckScenario()
        {
            return ShowdownResult?.PlayerHands?.Any(h =>
                string.Equals(h.PlayerName, "The Deck", StringComparison.OrdinalIgnoreCase)) == true;
        }

        /// <summary>
        /// Gets the player's hand in a player-vs-deck scenario.
        /// </summary>
        private ShowdownPlayerHand? GetPlayerHand()
        {
            return ShowdownResult?.PlayerHands?.FirstOrDefault(h =>
                !string.Equals(h.PlayerName, "The Deck", StringComparison.OrdinalIgnoreCase));
        }

        /// <summary>
        /// Gets the deck's hand in a player-vs-deck scenario.
        /// </summary>
        private ShowdownPlayerHand? GetDeckHand()
        {
            return ShowdownResult?.PlayerHands?.FirstOrDefault(h =>
                string.Equals(h.PlayerName, "The Deck", StringComparison.OrdinalIgnoreCase));
        }
    }
