@using CardGames.Poker.Api.Contracts
@using CardGames.Core.French.Cards
@using CardGames.Poker.Evaluation
@using CardGames.Poker.Hands
@using CardGames.Poker.Hands.DrawHands
@using CardGames.Poker.Hands.StudHands

@using System.Globalization

<div class="table-overlay showdown-overlay" role="dialog" aria-modal="true" aria-label="Showdown results">
    <div class="overlay-content showdown-content @(ShowdownWon ? "showdown-win" : ShowdownLost ? "showdown-lose" : "")">
        <button type="button" class="showdown-close" @onclick="OnClose" aria-label="Close showdown">
            &times;
        </button>

        @if (ShowdownWon)
        {
            <div class="sd-confetti" aria-hidden="true">
                @for (var i = 0; i < 28; i++)
                {
                    <span class="sd-confetti-piece" style="--i:@i"></span>
                }
            </div>
        }

        <header class="showdown-header">
            <div class="overlay-icon showdown-icon" aria-hidden="true">
                @if (ShowdownWon)
                {
                    <i class="fa-solid fa-crown"></i>
                }
                else
                {
                    <i class="fa-regular fa-face-grin-tears"></i>
                }
            </div>
            <div class="showdown-heading">
                <h2 class="showdown-title">Showdown</h2>
                <div class="showdown-subtitle">@GetOutcomeSubtitle()</div>
            </div>
        </header>

        @if (ShowdownResult is null)
        {
            <p class="showdown-empty">No showdown data.</p>
        }
        else if (ShowdownResult.WonByFold == true)
        {
            string? winnerName = null;
            var winnerChips = 0;

            if (ShowdownResult.Payouts is not null && ShowdownResult.Payouts.Count > 0)
            {
                var first = ShowdownResult.Payouts.First();
                winnerName = first.Key;
                winnerChips = first.Value;
            }

            // Prefer first name provided by the API (avoid parsing full display name).
            var winnerHand = ShowdownResult.PlayerHands?.FirstOrDefault(h => h.IsWinner == true);
            if (!string.IsNullOrWhiteSpace(winnerHand?.PlayerFirstName))
            {
                winnerName = winnerHand.PlayerFirstName;
            }

            <section class="showdown-winner" aria-label="Winner">
                <div class="winner-banner">
                    <div class="winner-nameline">
                        <span class="winner-first">@winnerName</span>
                        <span class="winner-rest">wins by fold</span>
                    </div>
                    @if (winnerChips > 0)
                    {
                        <div class="winner-pills">
                            <span class="sd-pill sd-pill-gold">+@winnerChips chips</span>
                        </div>
                    }
                </div>
            </section>

            <div class="showdown-winners">
                <h3>Payouts</h3>
                @if (ShowdownResult.Payouts is not null)
                {
                    @foreach (var payout in ShowdownResult.Payouts)
                    {
                        <div class="showdown-winner-row">
                            <span class="winner-name">@payout.Key</span>
                            <span class="winner-amount">+@payout.Value</span>
                        </div>
                    }
                }
            </div>
        }
        else
        {
            var winnerHand = GetPrimaryWinnerHand(ShowdownResult);
            var otherHands = GetOtherHands(ShowdownResult, winnerHand);

            @if (winnerHand is not null)
            {
                var winnerCards = GetDisplayCards(winnerHand);
                <section class="showdown-winner" aria-label="Winner">
                    <div class="winner-banner">
                        <div class="winner-nameline">
                            <span class="winner-first">@DisplayFirstName(winnerHand)</span>
                            <span class="winner-rest">takes it</span>
                        </div>
                        <div class="winner-pills">
                            @if (!string.IsNullOrWhiteSpace(winnerHand.HandType))
                            {
                                <span class="sd-pill sd-pill-green">@GetDetailedHandDescription(winnerHand)</span>
                            }
                            @if (winnerHand.AmountWon.GetValueOrDefault() > 0)
                            {
                                <span class="sd-pill sd-pill-gold">+@winnerHand.AmountWon.GetValueOrDefault() chips</span>
                            }
                        </div>

                        @if (winnerCards.Count > 0)
                        {
                            <div class="showdown-cards winner-cards" aria-label="Winning cards">
                                @for (var i = 0; i < winnerCards.Count; i++)
                                {
                                    var card = winnerCards[i];
                                    <div class="sd-card-wrapper" style="--i:@i">
                                        <playing-card rank="@GetPlayingCardRank(card)" suit="@GetPlayingCardSuit(card)" style="height:75px;width:75px;filter:drop-shadow(0 10px 18px rgba(0,0,0,.35));"></playing-card>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </section>
            }

            @if (otherHands.Count > 0)
            {
                <section class="showdown-others" aria-label="Other hands">
                    @foreach (var hand in otherHands)
                    {
                        var handCards = GetDisplayCards(hand);
                        <div class="other-hand-row">
                            <div class="other-hand-info">
                                <span class="other-hand-name">@DisplayFirstName(hand)</span>
                                @if (!string.IsNullOrWhiteSpace(hand.HandType))
                                {
                                    <span class="sd-pill sd-pill-muted">@GetDetailedHandDescription(hand)</span>
                                }
                                @if (hand.AmountWon.GetValueOrDefault() > 0)
                                {
                                    <span class="sd-pill sd-pill-gold">+@hand.AmountWon.GetValueOrDefault() chips</span>
                                }
                            </div>
                            @if (handCards.Count > 0)
                            {
                                <div class="showdown-cards other-cards">
                                    @foreach (var c in handCards)
                                    {
                                        <div class="">
                                            <playing-card rank="@GetPlayingCardRank(c)" suit="@GetPlayingCardSuit(c)" style="height:64px;width:48px;"></playing-card>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </section>
            }

            <div class="showdown-winners">
                <h3>Payouts</h3>
                @if (ShowdownResult.Payouts is not null)
                {
                    @foreach (var payout in ShowdownResult.Payouts)
                    {
                        <div class="showdown-winner-row">
                            <span class="winner-name">@payout.Key</span>
                            <span class="winner-amount">+@payout.Value</span>
                        </div>
                    }
                }
            </div>
        }

        <div class="showdown-countdown">
            @if (SecondsUntilNextHand > 0)
            {
                <p class="showdown-hint">Next hand starts in <strong>@SecondsUntilNextHand</strong> seconds...</p>
            }
            else
            {
                <p class="showdown-hint">Starting next hand...</p>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public PerformShowdownSuccessful? ShowdownResult { get; set; }

    [Parameter]
    public bool ShowdownWon { get; set; }

    [Parameter]
    public bool ShowdownLost { get; set; }

    [Parameter]
    public int SecondsUntilNextHand { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private static ShowdownPlayerHand? GetPrimaryWinnerHand(PerformShowdownSuccessful result)
    {
        if (result.PlayerHands is null || result.PlayerHands.Count == 0)
        {
            return null;
        }

        return result.PlayerHands
            .Where(h => h is not null)
            .Select(h => EnrichHand(h, result.Payouts))
            .OrderByDescending(h => h.IsWinner == true)
            .ThenByDescending(h => h.AmountWon ?? 0)
            .ThenByDescending(h => h.HandStrength ?? 0)
            .FirstOrDefault();
    }

    private static List<ShowdownPlayerHand> GetOtherHands(PerformShowdownSuccessful result, ShowdownPlayerHand? primaryWinner)
    {
        if (result.PlayerHands is null)
        {
            return [];
        }

        var hands = result.PlayerHands
            .Where(h => h is not null)
            .Select(h => EnrichHand(h, result.Payouts))
            .ToList();

        if (primaryWinner is not null)
        {
            // Remove primary winner (matching by name)
            var toRemove = hands.FirstOrDefault(h => h.PlayerName == primaryWinner.PlayerName);
            if (toRemove is not null)
            {
                hands.Remove(toRemove);
            }
        }

        return hands
            .OrderByDescending(h => h.IsWinner == true)
            .ThenByDescending(h => h.AmountWon ?? 0)
            .ThenBy(h => h.PlayerName)
            .ToList();
    }

    private static ShowdownPlayerHand EnrichHand(ShowdownPlayerHand hand, IDictionary<string, int>? payouts)
    {
        if (payouts is not null && payouts.TryGetValue(hand.PlayerName, out var amount))
        {
            // Always prefer the value in Payouts if it's larger (or if AmountWon is missing/zero)
            var current = hand.AmountWon ?? 0;
            if (amount > current)
            {
                return hand with { AmountWon = amount };
            }
        }
        return hand;
    }

    /// <summary>
    /// Gets the cards to display for a player's hand.
    /// For Seven Card Stud (7 cards), returns only the best 5 cards.
    /// Uses BestCardIndexes if provided by API, otherwise computes client-side.
    /// For other games, returns all cards sorted by symbol.
    /// </summary>
    private static List<ShowdownCard> GetDisplayCards(ShowdownPlayerHand hand)
    {
        if (hand.Cards is null || hand.Cards.Count == 0)
        {
            return [];
        }

        var cardsList = hand.Cards.ToList();

        // If BestCardIndexes is provided and valid, use only those cards
        if (hand.BestCardIndexes is not null && hand.BestCardIndexes.Count == 5)
        {
            return hand.BestCardIndexes
                .Where(idx => idx >= 0 && idx < cardsList.Count)
                .Select(idx => cardsList[idx])
                .OrderBy(c => c.Symbol)
                .ToList();
        }

        // For 7-card hands (Seven Card Stud), compute best 5 cards client-side
        if (cardsList.Count == 7)
        {
            var coreCards = cardsList
                .Where(c => c is { Suit: not null, Symbol: not null })
                .Select(c => new Card(MapSuit(c.Suit!.Value), MapSymbol(c.Symbol!.Value)))
                .ToList();

            if (coreCards.Count == 7)
            {
                var studHand = new StudHand([], coreCards, []);
                var bestCards = studHand.GetBestHand();

                // Map back to ShowdownCards by matching suit and symbol
                // Use a list to track which cards have been used (to handle potential duplicates)
                var result = new List<ShowdownCard>();
                var usedIndexes = new HashSet<int>();

                foreach (var bc in bestCards)
                {
                    for (var i = 0; i < cardsList.Count; i++)
                    {
                        if (usedIndexes.Contains(i))
                        {
                            continue;
                        }

                        var sc = cardsList[i];
                        if (sc.Suit.HasValue && sc.Symbol.HasValue &&
                            MapSuit(sc.Suit.Value) == bc.Suit &&
                            MapSymbol(sc.Symbol.Value) == bc.Symbol)
                        {
                            result.Add(sc);
                            usedIndexes.Add(i);
                            break;
                        }
                    }
                }

                return result.OrderBy(c => c.Symbol).ToList();
            }
        }

        // Fall back to showing all cards (for 5-card games)
        return cardsList.OrderBy(c => c.Symbol).ToList();
    }

    private string? GetPlayingCardSuit(ShowdownCard card)
    {
        var suit = card.Suit switch
        {
            CardSuit.Hearts => "Hearts",
            CardSuit.Diamonds => "Diamonds",
            CardSuit.Clubs => "Clubs",
            CardSuit.Spades => "Spades",
            _ => ""
        };
        return suit;
    }

    private string? GetPlayingCardRank(ShowdownCard card)
    {
        var rank = card.Symbol switch
        {
            CardSymbol.Ace => "Ace",
            CardSymbol.Deuce => "2",
            CardSymbol.Three => "3",
            CardSymbol.Four => "4",
            CardSymbol.Five => "5",
            CardSymbol.Six => "6",
            CardSymbol.Seven => "7",
            CardSymbol.Eight => "8",
            CardSymbol.Nine => "9",
            CardSymbol.Ten => "10",
            CardSymbol.Jack => "Jack",
            CardSymbol.Queen => "Queen",
            CardSymbol.King => "King",
            _ => ""
        };

        return rank;
    }
    private string GetOutcomeSubtitle()
    {
        if (ShowdownResult?.WonByFold == true)
        {
            return "Everyone folded";
        }

        if (ShowdownWon)
        {
            return "You won the hand";
        }

        if (ShowdownLost)
        {
            return "Hand complete";
        }

        return "Results are in";
    }

    private static string DisplayFirstName(ShowdownPlayerHand? hand)
    {
        if (!string.IsNullOrWhiteSpace(hand?.PlayerFirstName))
        {
            return hand.PlayerFirstName;
        }

        if (string.IsNullOrWhiteSpace(hand?.PlayerName))
        {
            return "Player";
        }

        var parts = hand.PlayerName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length > 0 ? parts[0] : hand.PlayerName;
    }

    private static string HumanizeHandType(string? handType)
    {
        if (string.IsNullOrWhiteSpace(handType))
        {
            return "";
        }

        // Handles values like "FullHouse", "TwoPair", "HighCard".
        var s = handType.Trim();
        s = System.Text.RegularExpressions.Regex.Replace(s, "([a-z])([A-Z])", "$1 $2");
        s = System.Text.RegularExpressions.Regex.Replace(s, "([A-Z])([A-Z][a-z])", "$1 $2");
        return CultureInfo.InvariantCulture.TextInfo.ToTitleCase(s);
    }

    private static string GetSuitColorClass(CardSuit? suit)
    {
        return suit switch
        {
            CardSuit.Hearts or CardSuit.Diamonds => "suit-red",
            _ => "suit-black"
        };
    }

    private static string GetDetailedHandDescription(ShowdownPlayerHand hand)
    {
        // Prefer server-provided hand description (already handles wild cards)
        if (!string.IsNullOrWhiteSpace(hand.HandDescription))
        {
            return hand.HandDescription;
        }

        if (hand.Cards is null || hand.Cards.Count < 5)
        {
            return HumanizeHandType(hand.HandType);
        }

        var coreCards = hand.Cards
            .Where(c => c is { Suit: not null, Symbol: not null })
            .Select(c => new Card(MapSuit(c.Suit!.Value), MapSymbol(c.Symbol!.Value)))
            .ToList();

        if (coreCards.Count < 5)
        {
            return HumanizeHandType(hand.HandType);
        }

        // If the server did not provide a description, do not try to infer variant rules from card faces.
        // (A Five Card Draw hand can contain 2s/Jacks/Kd too.)
        // For hands with more than 5 cards (e.g., Seven Card Stud with 7), use StudHand to find the best 5-card combination.
        HandBase evaluatedHand = coreCards.Count == 5
            ? new DrawHand(coreCards)
            : new StudHand([], coreCards, []);

        return HandDescriptionFormatter.GetHandDescription(evaluatedHand);
    }

    private static Suit MapSuit(CardSuit suit) => suit switch
    {
        CardSuit.Hearts => Suit.Hearts,
        CardSuit.Diamonds => Suit.Diamonds,
        CardSuit.Spades => Suit.Spades,
        CardSuit.Clubs => Suit.Clubs,
        _ => throw new ArgumentOutOfRangeException(nameof(suit), suit, "Unknown suit")
    };

    private static Symbol MapSymbol(CardSymbol symbol) => symbol switch
    {
        CardSymbol.Deuce => Symbol.Deuce,
        CardSymbol.Three => Symbol.Three,
        CardSymbol.Four => Symbol.Four,
        CardSymbol.Five => Symbol.Five,
        CardSymbol.Six => Symbol.Six,
        CardSymbol.Seven => Symbol.Seven,
        CardSymbol.Eight => Symbol.Eight,
        CardSymbol.Nine => Symbol.Nine,
        CardSymbol.Ten => Symbol.Ten,
        CardSymbol.Jack => Symbol.Jack,
        CardSymbol.Queen => Symbol.Queen,
        CardSymbol.King => Symbol.King,
        CardSymbol.Ace => Symbol.Ace,
        _ => throw new ArgumentOutOfRangeException(nameof(symbol), symbol, "Unknown symbol")
    };

    private static string GetSuitFaIcon(CardSuit? suit)
    {
        return suit switch
        {
            CardSuit.Hearts => "fa-heart",
            CardSuit.Diamonds => "fa-diamond",
            CardSuit.Clubs => "fa-club",
            CardSuit.Spades => "fa-spade",
            _ => "fa-question"
        };
    }

    private static string GetRankLabel(CardSymbol? symbol)
    {
        return symbol switch
        {
            CardSymbol.Deuce => "2",
            CardSymbol.Three => "3",
            CardSymbol.Four => "4",
            CardSymbol.Five => "5",
            CardSymbol.Six => "6",
            CardSymbol.Seven => "7",
            CardSymbol.Eight => "8",
            CardSymbol.Nine => "9",
            CardSymbol.Ten => "10",
            CardSymbol.Jack => "J",
            CardSymbol.Queen => "Q",
            CardSymbol.King => "K",
            CardSymbol.Ace => "A",
            _ => "?"
        };
    }
}
