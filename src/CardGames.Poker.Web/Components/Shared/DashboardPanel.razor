@namespace CardGames.Poker.Web.Components.Shared

@inject Services.DashboardState DashboardState
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="dashboard-panel @(DashboardState.IsOpen ? "expanded" : "collapsed")">
    <button class="dashboard-toggle" 
            @onclick="DashboardState.Toggle" 
            aria-expanded="@DashboardState.IsOpen" 
            aria-controls="dashboard-content"
            aria-label="@(DashboardState.IsOpen ? "Close dashboard" : "Open dashboard")">
        <span class="toggle-icon">
            @if (DashboardState.IsOpen)
            {
                <i class="fa-solid fa-chevron-left"></i>
            }
            else
            {
                <i class="fa-solid fa-chevron-right"></i>
            }
        </span>
        <span class="toggle-label">@(DashboardState.IsOpen ? "" : "Stats")</span>
    </button>

    <div class="resize-handle" @ref="_resizeHandle" title="Drag to resize"></div>

    <div id="dashboard-content" 
         class="dashboard-content" 
         @ref="_panelContent"
         style="width: @(DashboardState.Width)px;">
        <div class="dashboard-header">
            <i class="fa-solid fa-chart-line"></i>
            <span>Dashboard</span>
        </div>

        <div class="dashboard-sections">
            @ChildContent
        </div>
    </div>
</div>

@code {
    /// <summary>
    /// The content (sections) to display inside the dashboard panel.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private ElementReference _panelContent;
    private ElementReference _resizeHandle;
    private IJSObjectReference? _jsModule;
    private IJSObjectReference? _resizeInstance;
    private DotNetObjectReference<DashboardPanel>? _dotNetRef;

    protected override void OnInitialized()
    {
        DashboardState.OnStateChanged += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            
            // Import the JS module
            _jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                "import", 
                "./Components/Shared/DashboardPanel.razor.js");
            
            // Get stored width from localStorage and apply to state
            var storedWidth = await _jsModule.InvokeAsync<int>("getStoredWidth");
            DashboardState.Width = storedWidth;
            
            // Initialize resize functionality
            _resizeInstance = await _jsModule.InvokeAsync<IJSObjectReference>(
                "initResize", 
                _panelContent, 
                _resizeHandle, 
                _dotNetRef);
            
            StateHasChanged();
        }
    }

    /// <summary>
    /// Called from JavaScript when resize drag operation completes.
    /// </summary>
    [JSInvokable]
    public void OnResizeComplete(int newWidth)
    {
        DashboardState.Width = newWidth;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        DashboardState.OnStateChanged -= StateHasChanged;
        
        if (_resizeInstance is not null)
        {
            try
            {
                await _resizeInstance.InvokeVoidAsync("dispose");
                await _resizeInstance.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected, ignore
            }
        }
        
        if (_jsModule is not null)
        {
            try
            {
                await _jsModule.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected, ignore
            }
        }
        
        _dotNetRef?.Dispose();
    }
}
