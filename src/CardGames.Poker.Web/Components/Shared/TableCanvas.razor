@namespace CardGames.Poker.Web.Components.Shared

@using static CardGames.Poker.Web.Components.Pages.TablePlay

<div class="table-canvas">
    <!-- Poker table background -->
    <div class="poker-table">
        <div class="poker-table-felt">
            <!-- Center area with pot and phase -->
            <div class="table-center">
                @if (Pot > 0)
                {
                    <div class="pot-display">
                        <span class="pot-icon"><i class="fa-regular fa-coins"></i></span>
                        <span class="pot-amount">@Pot.ToString("N0")</span>
                    </div>
                }

                @if (CurrentPhase != GamePhase.WaitingForPlayers.ToString() && CurrentPhase != GamePhase.Ended.ToString())
                {
                    <div class="phase-indicator">
                        @GetPhaseLabel()
                    </div>
                }

                <!-- Community cards area (for future variants like Hold'em) -->
                <div class="community-cards">
                    @* This will be populated for Hold'em/Omaha variants *@
                </div>
            </div>

            <!-- Dealer button -->
            @if (DealerSeatIndex >= 0 && CurrentPhase != GamePhase.WaitingForPlayers.ToString())
            {
                <div class="dealer-button" style="@GetDealerButtonPosition()">
                    D
                </div>
            }
        </div>

        <!-- Seats around the table -->
        @foreach (var seat in Seats)
        {
            <div class="table-seat @GetSeatPositionClass(seat.SeatIndex) @GetSeatStateClass(seat)"
                 @onclick="() => HandleSeatClick(seat)">
                
                <TableSeat 
                    Seat="seat"
                    IsDealer="@(seat.SeatIndex == DealerSeatIndex)"
                    IsCurrentActor="@(seat.SeatIndex == CurrentActorSeatIndex)"
                    IsCurrentPlayer="@(seat.SeatIndex == CurrentPlayerSeatIndex)"
                    IsSeatSelectionDisabledForCurrentUser="@(DisableSeatSelectionForCurrentUser && !seat.IsOccupied)"
                    ShowCards="@(CurrentPhase != GamePhase.WaitingForPlayers.ToString() && CurrentPhase != GamePhase.WaitingToStart.ToString() && seat.Cards.Count > 0)" />
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public List<SeatInfo> Seats { get; set; } = [];

    [Parameter]
    public int Pot { get; set; }

    [Parameter]
    public string? CurrentPhase { get; set; }
    
    [Parameter]
    public string? CurrentPhaseDescription { get; set; }
    
    [Parameter]
    public int CurrentActorSeatIndex { get; set; } = -1;

    [Parameter]
    public int DealerSeatIndex { get; set; } = -1;

    [Parameter]
    public int CurrentPlayerSeatIndex { get; set; } = -1;

    [Parameter]
    public bool DisableSeatSelectionForCurrentUser { get; set; }

    [Parameter]
    public EventCallback<int> OnSeatClick { get; set; }

    private async Task HandleSeatClick(SeatInfo seat)
    {
        if (DisableSeatSelectionForCurrentUser)
        {
            return;
        }

        if (!seat.IsOccupied && OnSeatClick.HasDelegate)
        {
            await OnSeatClick.InvokeAsync(seat.SeatIndex);
        }
    }

    private string GetPhaseLabel()
    {
        return CurrentPhaseDescription ?? "Unknown";
    }

    private string GetSeatPositionClass(int seatIndex)
    {
        // Keep the seat ordering stable, but rotate the visual layout so the current player
        // is always shown at the bottom (seat-position-0).
        var positionIndex = MapSeatIndexToDisplayPosition(seatIndex);
        return $"seat-position-{positionIndex}";
    }

    private int MapSeatIndexToDisplayPosition(int seatIndex)
    {
        const int seatCount = 8;
        if (seatIndex < 0)
        {
            return seatIndex;
        }

        // If we don't know who the current player is (e.g., spectators), use the natural layout.
        if (CurrentPlayerSeatIndex < 0)
        {
            return seatIndex % seatCount;
        }

        // Rotate so the current player maps to display position 0.
        return (seatIndex - CurrentPlayerSeatIndex + seatCount) % seatCount;
    }

    private string GetSeatStateClass(SeatInfo seat)
    {
        var classes = new List<string>();

        @* if (!seat.IsOccupied)
            classes.Add("seat-empty");
        else *@
            classes.Add("seat-occupied");

        if (seat.IsCurrentPlayer)
            classes.Add("seat-current-player");

        if (seat.SeatIndex == CurrentActorSeatIndex)
            classes.Add("seat-active-turn");

        if (seat.IsFolded)
            classes.Add("seat-folded");

        if (seat.IsAllIn)
            classes.Add("seat-all-in");

        if (seat.IsDisconnected)
            classes.Add("seat-disconnected");

        return string.Join(" ", classes);
    }

    private string GetDealerButtonPosition()
    {
        // Position the dealer button near the dealer's seat
        // Using CSS custom properties to position based on seat
        var positions = new Dictionary<int, (double left, double top)>
        {
            { 0, (50, 85) },   // Bottom center
            { 1, (20, 75) },   // Bottom left
            { 2, (8, 50) },    // Left
            { 3, (20, 25) },   // Top left
            { 4, (50, 15) },   // Top center
            { 5, (80, 25) },   // Top right
            { 6, (92, 50) },   // Right
            { 7, (80, 75) }    // Bottom right
        };

        var dealerDisplayIndex = MapSeatIndexToDisplayPosition(DealerSeatIndex);
        if (positions.TryGetValue(dealerDisplayIndex, out var pos))
        {
            return $"left: {pos.left}%; top: {pos.top}%;";
        }

        return "display: none;";
    }
}
