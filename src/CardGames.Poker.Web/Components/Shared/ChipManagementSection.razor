@namespace CardGames.Poker.Web.Components.Shared
@using CardGames.Contracts.SignalR
@using CardGames.Contracts.AddChips
@using CardGames.Poker.Api.Clients
@using ApexCharts

@* Chip Management Section - Displays chip stack, add chips interface, and history *@

<div class="chip-management-section">
    <!-- Current Chip Stack Display -->
    <div class="chip-stack-display">
        <div class="chip-stack-label">Current Stack:</div>
        <div class="chip-stack-value">
            @(ChipHistory?.CurrentChips.ToString("N0") ?? "0")
            @if (ChipHistory?.PendingChipsToAdd > 0)
            {
                <span class="pending-chips">(+@ChipHistory.PendingChipsToAdd.ToString("N0") pending)</span>
            }
        </div>
    </div>

    <!-- Add Chips Interface -->
    <div class="add-chips-form">
        <div class="form-group">
            <label for="chip-amount">Add Chips:</label>
            <input type="number" 
                   id="chip-amount" 
                   class="form-control" 
                   @bind="_chipAmount" 
                   min="1" 
                   step="100" 
                   placeholder="Enter amount" />
        </div>
        <button class="btn btn-primary" 
                @onclick="AddChipsAsync" 
                disabled="@(_isSubmitting || _chipAmount <= 0)">
            <i class="fa-solid fa-plus"></i>
            Add Chips
        </button>
    </div>

    <!-- Game Type Explanation -->
    <div class="chip-timing-info">
        @if (IsKingsAndLows)
        {
            <i class="fa-solid fa-info-circle"></i>
            <span>Chips are added immediately in Kings and Lows.</span>
        }
        else
        {
            <i class="fa-solid fa-clock"></i>
            <span>Chips will be added at the start of the next hand.</span>
        }
    </div>

    <!-- Info Message -->
    @if (!string.IsNullOrEmpty(_infoMessage))
    {
        <div class="info-message @_messageType">
            <i class="fa-solid @(_messageType == "success" ? "fa-circle-check" : "fa-circle-info")"></i>
            @_infoMessage
        </div>
    }

    <!-- Chip History Chart -->
    @if (ChipHistory?.History?.Any() == true)
    {
        <div class="chip-history-chart" @key="@($"chart-{ChipHistory.History.Count}-{ChipHistory.CurrentChips}")">
            <h4>Chip History (Last @ChipHistory.History.Count Hands)</h4>
            <ApexChart TItem="ChipHistoryEntryDto"
                       Title=""
                       Options="@_chartOptions"
                       Height="200">
				
	            <ApexPointSeries TItem="ChipHistoryEntryDto"
	                             Items="ChipHistory.History"
	                             Name="Chip Stack"
	                             SeriesType="SeriesType.Line"
	                             XValue="@(e => (object)e.HandNumber)"
	                             YValue="@(e => (decimal)e.ChipStackAfterHand)"
	                             Color="#10b981">

	            </ApexPointSeries>
            </ApexChart>
        </div>
    }
    else
    {
        <div class="no-history">
            <i class="fa-regular fa-chart-line"></i>
            <span>No chip history yet. Play some hands to see your progress!</span>
        </div>
    }
    
</div>

@code {
    private const string KingsAndLowsGameTypeCode = "KINGSANDLOWS";

    [Parameter]
    public ChipHistoryDto? ChipHistory { get; set; }

    [Parameter]
    public Guid GameId { get; set; }

    [Parameter]
    public Guid PlayerId { get; set; }

    [Parameter]
    public string? GameTypeCode { get; set; }

    [Parameter]
    public EventCallback OnChipsAdded { get; set; }

    [Inject]
    private IGamesApi GamesApiClient { get; set; } = null!;

    [Inject]
    private ILogger<ChipManagementSection> Logger { get; set; } = null!;
    private ApexChartOptions<ChipHistoryEntryDto>? _chartOptions;
    private int _chipAmount = 500;
    private bool _isSubmitting;
    private string? _infoMessage;
    private string _messageType = "info";
    private int? _previousPendingChips;

    private bool IsKingsAndLows => 
        string.Equals(GameTypeCode, KingsAndLowsGameTypeCode, StringComparison.OrdinalIgnoreCase);

    protected override void OnInitialized()
    {
        _chartOptions = new ApexChartOptions<ChipHistoryEntryDto>
	    {
		    DataLabels = new DataLabels
		    {
			    Enabled = true, // Set to true to show point labels
			    // Optional: Further customization can be added here
			    // Formatter can be used for custom text/formatting if needed (requires JS for Blazor Server)
		    },
		    // --- X-axis Configuration ---
		    Xaxis = new XAxis
		    {
			    // Set the label style
				Labels = new XAxisLabels
			    {
					Style = new AxisLabelStyle
				    {
					    Colors = new List<string> { "#FFFFFF" },
					    FontSize = "12px",
					    FontFamily = "Arial, sans-serif"
				    }
			    },
			    // Optional: set axis border color
			    AxisBorder = new AxisBorder
			    {
				    Show = true,
				    Color = "#FF0000"
			    }
		    },
		    // --- Y-axis Configuration ---
		    Yaxis =
		    [
			    new YAxis
			    {
				    // Set the label style
				    Labels = new YAxisLabels
				    {
                        Style = new AxisLabelStyle
					    {
						    Colors = new List<string> { "#FFFFFF" }
					    }
				    },
			    }
		    ]
	    };
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        // Clear success message when pending chips have been applied
        if (ChipHistory != null && _previousPendingChips.HasValue && _previousPendingChips.Value > 0 && ChipHistory.PendingChipsToAdd == 0)
        {
            if (_messageType == "success")
            {
                _infoMessage = null;
            }
        }

        _previousPendingChips = ChipHistory?.PendingChipsToAdd;
    }

    private async Task AddChipsAsync()
    {
        if (_chipAmount <= 0)
        {
            _infoMessage = "Please enter a positive amount.";
            _messageType = "error";
            return;
        }

        _isSubmitting = true;
        _infoMessage = null;

        try
        {
            var request = new AddChipsRequest { Amount = _chipAmount };
            var result = await GamesApiClient.AddChipsAsync(GameId, PlayerId, request);

            if (result.IsSuccessStatusCode && result.Content != null)
            {
                _infoMessage = result.Content.Message;
                _messageType = "success";
                _chipAmount = 500; // Reset to default

                // Notify parent component
                await OnChipsAdded.InvokeAsync();
            }
            else
            {
                _infoMessage = "Failed to add chips. Please try again.";
                _messageType = "error";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to add chips");
            _infoMessage = "Failed to add chips. Please try again.";
            _messageType = "error";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private string GetChangeClass(int change)
    {
        return change > 0 ? "positive" : change < 0 ? "negative" : "neutral";
    }

    private string FormatChange(int change)
    {
        if (change > 0)
            return $"+{change:N0}";
        return change.ToString("N0");
    }
}
