@namespace CardGames.Poker.Web.Components.Shared
@using static CardGames.Poker.Web.Components.Pages.TablePlay
@using System.Threading
@implements IDisposable
@inject NavigationManager NavigationManager

<div class="seat-container @(IsCurrentPlayer ? "current-player-layout" : "remote-player-layout") @(Seat.IsOccupied ? "occupied" : "empty")">
	@if (Seat.IsOccupied)
	{
		<!-- Cards -->
		@if (ShowCards && Seat.Cards.Count > 0)
		{
			<div class="seat-cards-container">

				<div class="cards-fan">
					@foreach (var card in GetOrderedCards())
					{
						var rank = GetPlayingCardRank(card);
						var hasCardPayload = !string.IsNullOrWhiteSpace(card.Rank) && !string.IsNullOrWhiteSpace(card.Suit);
						// Logic from original: current player sees own cards, others see face up only if face up

						if (IsCurrentPlayer)
						{
							if (card.IsPubliclyVisible)
							{
								<div class="card-shell face-up">
									<playing-card rank="@rank" suit="@card.Suit" class="poker-card face-up" suitcolor="@(card.IsWild ? "green" : null)" rankcolor="@(card.IsWild ? "green" : null)" courtcolor="@(card.IsWild ? "green" : null)"></playing-card>
								</div>
							}
							else if (!hasCardPayload)
							{
								<div class="card-shell face-down">
									<playing-card rank="0" backcolor="#44F" class="poker-card face-down"></playing-card>
								</div>
							}
							else
							{
								<div class="card-shell face-down">
									<playing-card rank="@rank" suit="@card.Suit" class="poker-card face-down" suitcolor="@(card.IsWild ? "green" : null)" rankcolor="@(card.IsWild ? "green" : null)" courtcolor="@(card.IsWild ? "green" : null)"></playing-card>
								</div>
							}
						}
						else
						{
							if (card.IsFaceUp)
							{
								<playing-card rank="@rank" suit="@card.Suit" class="poker-card small"></playing-card>
							}
							else
							{
								<playing-card rank="0" backcolor="#44F" class="poker-card small"></playing-card>
							}
						}
					}
				</div>
			</div>
		}
		else if (ShowCards && !Seat.IsFolded && !Seat.IsSittingOut)
		{
			<!-- Placeholder cards -->
			<div class="seat-cards-container placeholder">
				<div class="cards-fan">
					@for (int i = 0; i < 5; i++)
					{
						<div class="playing-card-placeholder"></div>
					}
				</div>
			</div>
		}

		<!-- Main Player Display (Avatar + Info Pill) -->
		<div class="seat-visuals">

			<!-- Avatar Circle -->
			<div class="avatar-circle @GetAvatarStateClass()">
				@if (!string.IsNullOrWhiteSpace(Seat.PlayerAvatarUrl) && !_imageLoadError)
				{
					<img class="avatar-img" src="@GetSafeAvatarUrl()" alt="@GetDisplayName()" @onerror="OnImageError" />
				}
				else
				{
					<span class="avatar-initials">@GetInitials(GetDisplayName())</span>
				}

				@if (Seat.IsDisconnected)
				{
					<div class="status-overlay disconnected" title="Disconnected">?</div>
				}
				else if (Seat.SittingOutReason == "Observing")
				{
					<div class="status-overlay observing" title="Observing">
						<i class="fa-solid fa-eye"></i>
					</div>
				}
				else if (Seat.IsSittingOut)
				{
					<div class="status-overlay sitting-out" title="@(Seat.SittingOutReason ?? "Sitting out")">
						<i class="fa-solid fa-chair"></i>
					</div>
				}
			</div>

			<!-- Info Pill -->
			<div class="info-pill-container">
				<div class="info-pill">
					<div class="pill-top-row @GetPillStatusClass()">
						@if (ShouldShowStatusText())
						{
							if (!string.IsNullOrWhiteSpace(Seat.LastActionDescription))
							{
								<span class="action-text">@Seat.LastActionDescription</span>
							}
							else if (IsCurrentActor)
							{
								<span class="status-text glow-text">Waiting</span>
							}
							else if (Seat.SittingOutReason == "Observing")
							{
								<span class="status-text" title="@Seat.PlayerName">Observing</span>
							}
							else if (Seat.IsSittingOut)
							{
								<span class="status-text" title="@Seat.PlayerName">Sitting Out</span>
							}
						}
						else
						{
							<span class="player-name" title="@Seat.PlayerName">@GetDisplayName()</span>
						}
					</div>
					<div class="pill-bottom-row">
						<span class="chip-count">@Seat.Chips.ToString("N0")</span>
					</div>
				</div>

				@if (IsDealer)
				{
					<div class="seat-dealer-button" title="Dealer">D</div>
				}
			</div>

		</div>

		<!-- External Elements (Cards, Bets, Badges) -->
		@if (Seat.CurrentBet > 0)
		{
			<div class="seat-bet-bubble">
				<i class="fa-solid fa-coins"></i> @Seat.CurrentBet.ToString("N0")
			</div>
		}

		<!-- Hand Eval Tooltip (Shown on hover) -->
		@if (IsCurrentPlayer && ShowCards && Seat.Cards.Count > 0 && !string.IsNullOrWhiteSpace(Seat.HandEvaluationDescription))
		{
			<div class="hand-eval-tooltip">
				@Seat.HandEvaluationDescription
			</div>
		}
	}
	else
	{
		<button class="empty-seat-button" disabled="@IsSeatSelectionDisabledForCurrentUser" title="@(IsSeatSelectionDisabledForCurrentUser ? "Empty seat" : "Take a seat")">
			@(IsSeatSelectionDisabledForCurrentUser ? "Empty" : "Sit Here")
		</button>
	}
</div>

@code {
	[Parameter, EditorRequired]
	public required SeatInfo Seat { get; set; }

	[Parameter]
	public bool IsDealer { get; set; }

	[Parameter]
	public bool IsCurrentActor { get; set; }

	[Parameter]
	public bool IsCurrentPlayer { get; set; }

	[Parameter]
	public bool ShowCards { get; set; }

	[Parameter]
	public string? GameTypeCode { get; set; }

	[Parameter]
	public bool IsSeatSelectionDisabledForCurrentUser { get; set; }

	private bool _imageLoadError;
	private string? _lastAvatarUrl;
	private Timer? _alternationTimer;
	private bool _showAlternateStatus = true;

	protected override void OnInitialized()
	{
		_alternationTimer = new Timer(_ =>
		{
			_showAlternateStatus = !_showAlternateStatus;
			InvokeAsync(StateHasChanged);
		}, null, 3000, 3000);
	}

	public void Dispose()
	{
		_alternationTimer?.Dispose();
	}

	protected override void OnParametersSet()
	{
		if (Seat.PlayerAvatarUrl != _lastAvatarUrl)
		{
			_imageLoadError = false;
			_lastAvatarUrl = Seat.PlayerAvatarUrl;
		}
	}

	private void OnImageError(ErrorEventArgs args)
	{
		_imageLoadError = true;
	}

	private string GetSafeAvatarUrl()
	{
		if (string.IsNullOrWhiteSpace(Seat.PlayerAvatarUrl)) return "";
		var url = Seat.PlayerAvatarUrl.Trim();

		// Return original if it's absolute URL or data URI
		if (url.StartsWith("http", StringComparison.OrdinalIgnoreCase) ||
			url.StartsWith("data:", StringComparison.OrdinalIgnoreCase))
		{
			return url;
		}

		// If it starts with /, treat as relative to root, but respect base path
		if (url.StartsWith("/", StringComparison.Ordinal))
		{
			// Remove leading slash to combine with BaseUri
			url = url.Substring(1);
		}

		try
		{
			return NavigationManager.ToAbsoluteUri(url).ToString();
		}
		catch
		{
			return url;
		}
	}

	private string GetAvatarStateClass()
	{
		var classes = new List<string>();

		if (IsCurrentActor)
			classes.Add("active-turn-ring");

		if (Seat.IsFolded)
			classes.Add("folded");

		if (IsCurrentPlayer)
			classes.Add("is-me");

		return string.Join(" ", classes);
	}

	private string GetPillStatusClass()
	{
		// Check for statuses that should alternate with the name
		bool hasAlternateStatus = !string.IsNullOrWhiteSpace(Seat.LastActionDescription) ||
								  IsCurrentActor ||
								  Seat.SittingOutReason == "Observing" ||
								  Seat.IsSittingOut;

		// If we're alternating and currently showing the name, show passive/background status only
		if (hasAlternateStatus && !_showAlternateStatus)
		{
			return GetPassiveStatusClass();
		}

		// Show action status when player has a recent action to display
		if (!string.IsNullOrWhiteSpace(Seat.LastActionDescription))
			return "status-action";

		if (Seat.SittingOutReason == "Observing")
			return "status-observing";

		if (Seat.IsSittingOut)
			return "status-observing";

		if (IsCurrentActor)
			return "status-orange";

		return GetPassiveStatusClass();
	}

	private string GetPassiveStatusClass()
	{
		if (Seat.IsFolded)
			return "status-red";

		if (Seat.IsAllIn)
			return "status-gold";

		if (Seat.IsReady && !ShowCards)
			return "status-green";

		return string.Empty;
	}

	private bool ShouldShowStatusText()
	{
		if (!_showAlternateStatus) return false;

		return !string.IsNullOrWhiteSpace(Seat.LastActionDescription) ||
			   IsCurrentActor ||
			   Seat.SittingOutReason == "Observing" ||
			   Seat.IsSittingOut;
	}

	private static string GetInitials(string? name)
	{
		if (string.IsNullOrWhiteSpace(name))
			return "?";

		var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
		return parts.Length switch
		{
			0 => "?",
			1 => parts[0][..1].ToUpperInvariant(),
			_ => $"{parts[0][0]}{parts[^1][0]}".ToUpperInvariant()
		};
	}

	private string GetDisplayName()
	{
		if (!string.IsNullOrWhiteSpace(Seat.PlayerFirstName))
		{
			return Seat.PlayerFirstName;
		}

		var name = Seat.PlayerName;
		if (string.IsNullOrWhiteSpace(name))
		{
			return "?";
		}

		var atIndex = name.IndexOf("@", StringComparison.Ordinal);
		if (atIndex > 0)
		{
			return name[..atIndex];
		}

		var spaceIndex = name.IndexOf(' ', StringComparison.Ordinal);
		return spaceIndex > 0 ? name[..spaceIndex] : name;
	}

	private IEnumerable<CardInfo> GetOrderedCards()
	{
		if (Seat.Cards.Count == 0)
		{
			return [];
		}

		// Seven Card Stud variants: The API already orders cards correctly using a composite key
		// (phase + location + deal order). Do NOT re-sort here as DealOrder alone is unreliable
		// (it can have ties across different streets, causing incorrect interleaving).
		if (string.Equals(GameTypeCode, "SEVENCARDSTUD", StringComparison.OrdinalIgnoreCase) ||
			string.Equals(GameTypeCode, "BASEBALL", StringComparison.OrdinalIgnoreCase) ||
			string.Equals(GameTypeCode, "FOLLOWTHEQUEEN", StringComparison.OrdinalIgnoreCase))
		{
			// Preserve the API order - cards are already sorted by the server
			return Seat.Cards;
		}

		// Sort by card value (2 lowest, Ace highest) for Five Card Draw display.
		return Seat.Cards.OrderBy(GetCardValueOrder);
	}

	private static int GetCardValueOrder(CardInfo card)
	{
		return card.Rank switch
		{
			"2" => 2,
			"3" => 3,
			"4" => 4,
			"5" => 5,
			"6" => 6,
			"7" => 7,
			"8" => 8,
			"9" => 9,
			"10" => 10,
			"J" => 11,
			"Q" => 12,
			"K" => 13,
			"A" => 14,
			_ => 0
		};
	}

	private string? GetPlayingCardRank(CardInfo card)
	{
		return card.Rank switch
		{
			"J" => "Jack",
			"Q" => "Queen",
			"K" => "King",
			"A" => "Ace",
			_ => card.Rank
		};
	}
}
