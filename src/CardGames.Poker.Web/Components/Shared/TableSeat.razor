@namespace CardGames.Poker.Web.Components.Shared
@using static CardGames.Poker.Web.Components.Pages.TablePlay

<div class="seat-container @(IsCurrentPlayer ? "current-player-layout" : "remote-player-layout") @(Seat.IsOccupied ? "occupied" : "empty")">
    @if (Seat.IsOccupied)
    {
        <!-- Main Player Display (Avatar + Info Pill) -->
        <div class="seat-visuals">
            
            <!-- Avatar Circle -->
            <div class="avatar-circle @GetAvatarStateClass()">
                @if (!string.IsNullOrWhiteSpace(Seat.PlayerAvatarUrl))
                {
                    <img class="avatar-img" src="@Seat.PlayerAvatarUrl" alt="@GetDisplayName()" />
                }
                else
                {
                    <span class="avatar-initials">@GetInitials(GetDisplayName())</span>
                }

                @if (Seat.IsDisconnected)
                {
                    <div class="status-overlay disconnected" title="Disconnected">?</div>
                }
                else if (Seat.IsSittingOut)
                {
                    <div class="status-overlay sitting-out" title="@(Seat.SittingOutReason ?? "Sitting out")">
                        <i class="fa-solid fa-chair"></i>
                    </div>
                }
            </div>

            <!-- Info Pill -->
            <div class="info-pill">
                <div class="pill-top-row @GetPillStatusClass()">
                    @if (IsCurrentActor)
                    {
                        <span class="status-text glow-text">Waiting</span>
                    }
                    else
                    {
                        <span class="player-name" title="@Seat.PlayerName">@GetDisplayName()</span>
                    }
                </div>
                <div class="pill-bottom-row">
                    <span class="chip-count">@Seat.Chips.ToString("N0")</span>
                </div>
            </div>

        </div>

        <!-- External Elements (Cards, Bets, Badges) -->

        @if (Seat.CurrentBet > 0)
        {
            <div class="seat-bet-bubble">
                <i class="fa-solid fa-coins"></i> @Seat.CurrentBet.ToString("N0")
            </div>
        }

        <!-- Hand Eval Tooltip (Shown on hover) -->
        @if (IsCurrentPlayer && ShowCards && Seat.Cards.Count > 0 && !string.IsNullOrWhiteSpace(Seat.HandEvaluationDescription))
        {
            <div class="hand-eval-tooltip">
                @Seat.HandEvaluationDescription
            </div>
        }

        <!-- Cards -->
        @if (ShowCards && Seat.Cards.Count > 0)
        {
            <div class="seat-cards-container">

                <div class="cards-fan">
                    @foreach (var card in GetOrderedCards())
                    {
                        var rank = GetPlayingCardRank(card);
                        // Logic from original: current player sees own cards, others see face up only if face up
                        
                        if (IsCurrentPlayer)
                        {
                             if (card.IsFaceUp)
                             {
                                <playing-card rank="@rank" suit="@card.Suit" class="poker-card"></playing-card>
                             }
                             else
                             {
                                <playing-card rank="0" backcolor="#44F" class="poker-card"></playing-card>
                             }
                        }
                        else
                        {
                             if (card.IsFaceUp)
                             {
                                <playing-card rank="@rank" suit="@card.Suit" class="poker-card small"></playing-card>
                             }
                             else
                             {
                                <playing-card rank="0" backcolor="#44F" class="poker-card small"></playing-card>
                             }
                        }
                    }
                </div>
            </div>
        }
        else if (ShowCards && !Seat.IsFolded)
        {
             <!-- Placeholder cards -->
            <div class="seat-cards-container placeholder">
                <div class="cards-fan">
                    @for (int i = 0; i < 5; i++)
                    {
                         <div class="playing-card-placeholder"></div>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <button class="empty-seat-button" disabled="@IsSeatSelectionDisabledForCurrentUser" title="@(IsSeatSelectionDisabledForCurrentUser ? "Empty seat" : "Take a seat")">
            @(IsSeatSelectionDisabledForCurrentUser ? "Empty" : "Sit Here")
        </button>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public required SeatInfo Seat { get; set; }

    [Parameter]
    public bool IsDealer { get; set; }

    [Parameter]
    public bool IsCurrentActor { get; set; }

    [Parameter]
    public bool IsCurrentPlayer { get; set; }

    [Parameter]
    public bool ShowCards { get; set; }

    [Parameter]
    public bool IsSeatSelectionDisabledForCurrentUser { get; set; }

    private string GetAvatarStateClass()
    {
        var classes = new List<string>();

        if (IsCurrentActor)
            classes.Add("active-turn-ring");

        if (Seat.IsFolded)
            classes.Add("folded");

        if (IsCurrentPlayer)
            classes.Add("is-me");

        return string.Join(" ", classes);
    }

    private string GetPillStatusClass()
    {
        if (IsCurrentActor)
            return "status-orange";

        if (Seat.IsFolded)
            return "status-red";

        if (Seat.IsAllIn)
            return "status-gold";

        if (Seat.IsReady && !ShowCards)
            return "status-green";

        return string.Empty;
    }

    private static string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "?";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length switch
        {
            0 => "?",
            1 => parts[0][..1].ToUpperInvariant(),
            _ => $"{parts[0][0]}{parts[^1][0]}".ToUpperInvariant()
        };
    }

	private string GetDisplayName()
	{
		if (!string.IsNullOrWhiteSpace(Seat.PlayerFirstName))
		{
			return Seat.PlayerFirstName;
		}

		var name = Seat.PlayerName;
		if (string.IsNullOrWhiteSpace(name))
		{
			return "?";
		}

		var atIndex = name.IndexOf("@", StringComparison.Ordinal);
		if (atIndex > 0)
		{
			return name[..atIndex];
		}

		var spaceIndex = name.IndexOf(' ', StringComparison.Ordinal);
		return spaceIndex > 0 ? name[..spaceIndex] : name;
	}

    private IEnumerable<CardInfo> GetOrderedCards()
    {
        if (Seat.Cards.Count == 0)
        {
            return [];
        }

        return Seat.Cards
            .Select((card, index) => new { card, index })
            .OrderBy(x => string.IsNullOrWhiteSpace(x.card.Rank) ? 1 : 0) // Face down/unknown last or stable
            .ThenBy(x => GetRankValue(x.card.Rank))
            .ThenBy(x => GetSuitValue(x.card.Suit))
            .ThenBy(x => x.index)
            .Select(x => x.card);
    }

    private static int GetRankValue(string? rank)
    {
        if (string.IsNullOrWhiteSpace(rank)) return int.MaxValue;
        return rank.Trim().ToUpperInvariant() switch
        {
            "2" or "TWO" or "DEUCE" => 2,
            "3" or "THREE" => 3,
            "4" or "FOUR" => 4,
            "5" or "FIVE" => 5,
            "6" or "SIX" => 6,
            "7" or "SEVEN" => 7,
            "8" or "EIGHT" => 8,
            "9" or "NINE" => 9,
            "10" or "T" or "TEN" => 10,
            "J" or "JACK" => 11,
            "Q" or "QUEEN" => 12,
            "K" or "KING" => 13,
            "A" or "ACE" => 14,
            _ => int.MaxValue
        };
    }

    private static int GetSuitValue(string? suit)
    {
        if (string.IsNullOrWhiteSpace(suit)) return int.MaxValue;
        return suit.Trim().ToLowerInvariant() switch
        {
            "clubs" or "c" => 0,
            "diamonds" or "d" => 1,
            "hearts" or "h" => 2,
            "spades" or "s" => 3,
            _ => int.MaxValue
        };
    }

    private string? GetPlayingCardRank(CardInfo card)
    {
        return card.Rank switch
        {
            "J" => "Jack",
            "Q" => "Queen",
            "K" => "King",
            "A" => "Ace",
            _ => card.Rank
        };
    }
}
