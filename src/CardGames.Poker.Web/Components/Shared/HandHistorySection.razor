@namespace CardGames.Poker.Web.Components.Shared
@using CardGames.Contracts.SignalR
@using CardGames.Poker.Api.Contracts

<div class="hand-history-section">
	@if (Entries is not null && Entries.Any())
	{
		<div class="history-list" role="list" aria-label="Hand history">
			@foreach (var entry in Entries.OrderByDescending(e => e.HandNumber))
			{
				var isExpanded = _expandedHandNumbers.Contains(entry.HandNumber);
				<div class="history-entry-container">
					<div class="history-entry-header @(isExpanded ? "expanded" : "")"
						 role="button"
						 tabindex="0"
						 aria-expanded="@isExpanded"
						 @onclick="() => ToggleExpand(entry.HandNumber)"
						 @onkeydown="(e) => HandleKeyDown(e, entry.HandNumber)">
						<span class="expand-icon">
							<i class="fa-solid @(isExpanded ? "fa-chevron-down" : "fa-chevron-right")" aria-hidden="true"></i>
						</span>
						<span class="cell hand-number">#@entry.HandNumber</span>
						<span class="cell winner-name" title="@GetWinnerTitle(entry)">
							@(string.IsNullOrWhiteSpace(entry.WinnerName) ? "Unknown" : entry.WinnerName)
						</span>
						<span class="cell amount-won">+@entry.AmountWon.ToString("N0")</span>
					</div>
					
					@if (isExpanded)
					{
						<div class="history-entry-details" role="region" aria-label="Hand #@entry.HandNumber details">
							<div class="details-header">
								@if (!string.IsNullOrWhiteSpace(entry.WinningHandDescription))
								{
									<span class="winning-hand">@entry.WinningHandDescription</span>
								}
								@if (entry.WonByFold == true)
								{
									<span class="won-by-fold">Won by fold</span>
								}
							</div>
							<div class="player-results-list">
								@if (entry.PlayerResults?.Any() == true)
								{
									@foreach (var player in entry.PlayerResults.OrderBy(p => p.SeatPosition))
									{
										<div class="player-result-row @GetPlayerResultClass(player.FinalAction)">
											<span class="player-name">@player.PlayerName</span>
											<span class="player-action">@FormatFinalAction(player.FinalAction)</span>
											<span class="player-net @GetNetAmountClass(player.NetAmount)">
												@FormatNetAmount(player.NetAmount)
											</span>
											@if (player.FinalVisibleCards?.Any() == true)
											{
												<span class="player-cards">
													@foreach (var card in player.FinalVisibleCards)
													{
														<span class="card-badge @GetSuitClass(card.Suit)">
															@card.Rank@GetSuitSymbol(card.Suit)
														</span>
													}
												</span>
											}
										</div>
									}
								}
								else
								{
									<div class="no-player-data">
										<span>Player details not available</span>
									</div>
								}
							</div>
						</div>
					}
				</div>
			}
		</div>
	}
	else
	{
		<div class="history-empty">
			<i class="fa-regular fa-clock-rotate-left" aria-hidden="true"></i>
			<span>No hands played yet</span>
		</div>
	}
</div>

@code {
	/// <summary>
	/// The list of hand history entries to display.
	/// </summary>
	[Parameter]
	public IReadOnlyList<HandHistoryEntryDto>? Entries { get; set; }

	private readonly HashSet<int> _expandedHandNumbers = new();

	private void ToggleExpand(int handNumber)
	{
		if (!_expandedHandNumbers.Remove(handNumber))
		{
			_expandedHandNumbers.Add(handNumber);
		}
	}

	private void HandleKeyDown(KeyboardEventArgs e, int handNumber)
	{
		if (e.Key is "Enter" or " ")
		{
			ToggleExpand(handNumber);
		}
	}

	private static string GetWinnerTitle(HandHistoryEntryDto entry)
	{
		if (entry.WinnerCount > 1)
		{
			return $"{entry.WinnerName} (Split {entry.WinnerCount}-way)";
		}
		return entry.WinnerName;
	}

	private static string FormatFinalAction(PlayerFinalAction? action)
	{
		return action switch
		{
			PlayerFinalAction.Won => "Won",
			PlayerFinalAction.Lost => "Lost",
			PlayerFinalAction.SplitPot => "Split",
			PlayerFinalAction.Folded => "Folded",
			_ => "—"
		};
	}

	private static string GetPlayerResultClass(PlayerFinalAction? action)
	{
		return action switch
		{
			PlayerFinalAction.Won => "result-won",
			PlayerFinalAction.SplitPot => "result-split",
			PlayerFinalAction.Folded => "result-folded",
			PlayerFinalAction.Lost => "result-lost",
			_ => ""
		};
	}

	private static string GetNetAmountClass(int? amount)
	{
		return amount switch
		{
			> 0 => "net-positive",
			< 0 => "net-negative",
			_ => "net-zero"
		};
	}

	private static string FormatNetAmount(int? amount)
	{
		return amount switch
		{
			> 0 => $"+{amount:N0}",
			< 0 => amount.Value.ToString("N0"),
			_ => "0"
		};
	}

	private static string GetSuitClass(string? suit)
	{
		return suit?.ToLowerInvariant() switch
		{
			"hearts" or "diamonds" => "suit-red",
			"spades" or "clubs" => "suit-black",
			_ => ""
		};
	}

	private static string GetSuitSymbol(string? suit)
	{
		return suit?.ToLowerInvariant() switch
		{
			"hearts" => "♥",
			"diamonds" => "♦",
			"spades" => "♠",
			"clubs" => "♣",
			_ => ""
		};
	}
}
