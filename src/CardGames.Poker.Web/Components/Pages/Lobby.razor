@page "/lobby"
@page "/lobby/{Tab}"
@attribute [Authorize]
@rendermode InteractiveServer
@implements IAsyncDisposable

@using CardGames.Contracts.SignalR
@using CardGames.Poker.Api.Clients
@using CardGames.Poker.Api.Contracts
@using CardGames.Poker.Web.Components.Shared
@using CardGames.Poker.Web.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

<PageTitle>Lobby - Friday Night Poker</PageTitle>

<ConfirmDialog @bind-IsVisible="_showDeleteConfirmation"
               Title="Delete Table"
               Message="@_deleteConfirmationMessage"
               ConfirmText="Delete"
               CancelText="Cancel"
               ProcessingText="Deleting..."
               IconClass="fa-trash"
               ConfirmButtonClass="btn-danger"
               IsProcessing="_isDeleting"
               OnConfirm="ConfirmDeleteTableAsync"
               OnCancel="CancelDelete" />

<AuthenticatedNavBar />

<main class="lobby-main">
    <div class="lobby-container">
        <!-- Lobby Header -->
        <div class="lobby-header">
            <div class="lobby-header-content">
                <h1 class="lobby-title">
                    <i class="fa-regular fa-house"></i>
                    Game Lobby
                    @if (LobbyHubClient.IsInLobby)
                    {
                        <span class="connection-indicator connected" title="Real-time updates enabled">●</span>
                    }
                    else if (LobbyHubClient.IsConnected)
                    {
                        <span class="connection-indicator connecting" title="Connecting...">●</span>
                    }
                </h1>
                <p class="lobby-subtitle">Find a table or create your own private game</p>
            </div>
            <a href="/table/create" class="btn btn-primary btn-lg lobby-create-btn">
                <i class="fa-regular fa-add"></i> Create New Table
            </a>
        </div>

        <!-- Tab Navigation -->
        <div class="lobby-tabs">
            <a href="/lobby" class="lobby-tab @(IsActiveTab("") ? "active" : "")">
                <span class="lobby-tab-icon">🎯</span>
                <span class="lobby-tab-text">My Tables</span>
                <span class="lobby-tab-badge">@_myTablesCount</span>
            </a>
        </div>

        <!-- Filters Section -->
        <div class="lobby-filters">
            <div class="filter-group">
                <label class="filter-label">Variant</label>
                <select class="filter-select" @bind="_selectedVariant">
                    <option value="">All Variants</option>
                    @foreach (var gameType in _availableGameTypes)
                    {
                        <option value="@gameType.Name">@gameType.Name</option>
                    }
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Seats</label>
                <select class="filter-select" @bind="_selectedSeats">
                    <option value="">Any Size</option>
                    <option value="2">Heads Up (2)</option>
                    <option value="6">6-Max</option>
                    <option value="9">Full Ring (9)</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Status</label>
                <select class="filter-select" @bind="_selectedStatus">
                    <option value="">All</option>
                    <option value="waiting">Waiting for Players</option>
                    <option value="inprogress">In Progress</option>
                </select>
            </div>
            <button class="filter-clear-btn" @onclick="ClearFilters">
                <span>✕</span> Clear Filters
            </button>
            <div class="view-toggle-group" style="margin-left: auto; display: flex; gap: 0.5rem;">
                <button class="btn btn-view-toggle @(_viewMode == "grid" ? "active" : "")" @onclick="@(() => _viewMode = "grid")" title="Grid View">
                    <i class="fa-solid fa-th-large"></i>
                </button>
                <button class="btn btn-view-toggle @(_viewMode == "list" ? "active" : "")" @onclick="@(() => _viewMode = "list")" title="List View">
                    <i class="fa-solid fa-list"></i>
                </button>
            </div>
        </div>

        <!-- Tables Grid -->
        <div class="lobby-content">
            @if (_isLoading)
            {
                <div class="lobby-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading tables...</p>
                </div>
            }
            else if (_filteredTables.Count == 0)
            {
                <div class="lobby-empty">
                    <div class="empty-icon">@GetEmptyIcon()</div>
                    <h3 class="empty-title">@GetEmptyTitle()</h3>
                    <p class="empty-description">@GetEmptyDescription()</p>
                    @if (IsActiveTab(""))
                    {
                        <a href="/table/create" class="btn btn-primary">
                            <span>➕</span> Create a Table
                        </a>
                    }
                </div>
            }
            else
            {
                @if (_viewMode == "grid")
                {
                    <div class="tables-grid">
                        @foreach (var table in _filteredTables)
                        {
                            <TableCard Table="table" CurrentUserId="@_currentUserId" OnDelete="HandleDeleteTableAsync" />
                        }
                    </div>
                }
                else
                {
                    <div class="tables-list">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Game Type</th>
                                    <th>Table Name</th>
                                    <th>Host</th>
                                    <th>Phase</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var table in _filteredTables)
                                {
                                    <tr>
                                        <td class="text-end">
                                            <a href="/table/@table.Id" class="btn btn-sm btn-primary">Join</a>
                                        </td>
                                        <td>@table.GameTypeName</td>
                                        <td>@table.Name</td>
                                        <td>@table.CreatedByName</td>
                                        <td>@table.CurrentPhaseDescription</td>
                                        <td class="text-end">
                                            @if (CanDeleteTable(table))
                                            {
                                                <button class="btn btn-sm btn-primary" 
                                                        @onclick="() => HandleDeleteTableAsync(table.Id)"
                                                        disabled="@_isDeleting"
                                                        title="Delete table">
                                                    <i class="fa-regular fa-trash"></i>
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            }
        </div>
    </div>
</main>

@code {
    [Parameter]
    public string? Tab { get; set; }

    [Inject]
    private IActiveGamesApi ActiveGamesApi { get; set; } = default!;

    [Inject]
    private LobbyHubClient LobbyHubClient { get; set; } = default!;

    [Inject]
    private ILogger<Lobby> Logger { get; set; } = default!;

    [Inject]
    private IGamesApi GamesApi { get; set; } = default!;

    [Inject]
    private IAvailablePokerGamesApi AvailablePokerGamesApi { get; set; } = default!;

    [Inject]
    private AuthenticationStateProvider AuthenticationStateProvider { get; set; } = default!;

    private bool _isLoading = true;
    private string _viewMode = "list";
    private string _selectedVariant = "";
    private string _selectedSeats = "";
    private string _selectedStatus = "";
    private string? _currentUserId;
    private bool _isDeleting;
    private bool _showDeleteConfirmation;
    private Guid? _gameIdToDelete;
    private string _deleteConfirmationMessage = "Are you sure you want to delete this table? This action cannot be undone.";

    private int _myTablesCount;

    private List<GetActiveGamesResponse> _allTables = [];
    private List<GetActiveGamesResponse> _filteredTables = [];
    private List<GetAvailablePokerGamesResponse> _availableGameTypes = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUserAsync();
        var loadTablesTask = LoadTablesAsync();
        var loadAvailableGamesTask = LoadAvailableGamesAsync();
        await Task.WhenAll(loadTablesTask, loadAvailableGamesTask);
        await ConnectToLobbyHubAsync();
    }

    private async Task LoadCurrentUserAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            _currentUserId = user.FindFirstValue(ClaimTypes.NameIdentifier);
        }
    }

    private async Task ConnectToLobbyHubAsync()
    {
        try
        {
            LobbyHubClient.OnGameCreated += HandleGameCreatedAsync;
            LobbyHubClient.OnGameDeleted += HandleGameDeletedAsync;

            await LobbyHubClient.ConnectAsync();
            await LobbyHubClient.JoinLobbyAsync();

            Logger.LogInformation("Connected to lobby hub and joined lobby group");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to connect to lobby hub");
            // Continue without real-time updates - the page will still work with initial data
        }
    }

    private async Task HandleGameCreatedAsync(GameCreatedDto gameCreated)
    {
        Logger.LogInformation("Received new game: {GameId} ({GameName})", gameCreated.GameId, gameCreated.Name);

        // Check if game already exists in the list
        var existingIndex = _allTables.FindIndex(t => t.Id == gameCreated.GameId);

        // Convert GameCreatedDto to GetActiveGamesResponse and add to the list
        // The constructor takes parameters in alphabetical order (generated by NSwag)
        var newTable = new GetActiveGamesResponse(
            createdAt: gameCreated.CreatedAt,
            createdById: gameCreated.CreatedById ?? string.Empty,
            createdByName: gameCreated.CreatedByName ?? string.Empty,
            currentPhase: gameCreated.CurrentPhase,
            currentPhaseDescription: gameCreated.CurrentPhaseDescription,
            gameTypeCode: gameCreated.GameTypeCode,
            gameTypeDescription: gameCreated.GameTypeDescription,
            gameTypeId: gameCreated.GameTypeId,
            gameTypeImageName: gameCreated.GameTypeImageName,
            gameTypeMetadataName: gameCreated.GameTypeMetadataName,
            gameTypeName: gameCreated.GameTypeName,
            id: gameCreated.GameId,
            name: gameCreated.Name!,
            rowVersion: string.Empty,
            status: Enum.TryParse<GameStatus>(gameCreated.Status, out var status)
                ? status
                : GameStatus.WaitingForPlayers);

        if (existingIndex >= 0)
        {
            _allTables[existingIndex] = newTable;
        }
        else
        {
            _allTables.Insert(0, newTable);
        }
        _myTablesCount = _allTables.Count;
        ApplyFilters();


        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleGameDeletedAsync(Guid gameId)
    {
        Logger.LogInformation("Game deleted: {GameId}", gameId);

        var tableToRemove = _allTables.FirstOrDefault(t => t.Id == gameId);
        if (tableToRemove is not null)
        {
            _allTables.Remove(tableToRemove);
            _myTablesCount = _allTables.Count;
            ApplyFilters();

            await InvokeAsync(StateHasChanged);
        }
    }

    protected override void OnParametersSet()
    {
        ApplyFilters();
    }

    private async Task LoadTablesAsync()
    {
        _isLoading = true;

        var response = await ActiveGamesApi.GetActiveGamesAsync();
        _allTables = response.Content?.ToList() ?? [];
        _myTablesCount = _allTables.Count;

        ApplyFilters();
        _isLoading = false;
    }

    private async Task LoadAvailableGamesAsync()
    {
        try
        {
            var response = await AvailablePokerGamesApi.GetAvailablePokerGamesAsync();
            if (response.IsSuccessStatusCode && response.Content != null)
            {
                _availableGameTypes = response.Content.OrderBy(g => g.Name).ToList();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load available game types");
        }
    }

    private void ApplyFilters()
    {
        _filteredTables = _allTables
            .Where(t => string.IsNullOrEmpty(_selectedVariant) ||
                        t.GameTypeCode.Contains(_selectedVariant, StringComparison.OrdinalIgnoreCase) ||
                        t.GameTypeName.Contains(_selectedVariant, StringComparison.OrdinalIgnoreCase))
            .Where(t => string.IsNullOrEmpty(_selectedStatus) ||
                        t.Status.ToString().Contains(_selectedStatus, StringComparison.OrdinalIgnoreCase) ||
                        t.CurrentPhase.Contains(_selectedStatus, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private void ClearFilters()
    {
        _selectedVariant = "";
        _selectedSeats = "";
        _selectedStatus = "";
        ApplyFilters();
    }

    private bool IsActiveTab(string tab)
    {
        return string.Equals(Tab ?? "", tab, StringComparison.OrdinalIgnoreCase);
    }

    private string GetEmptyIcon()
    {
        return "🎯";
    }

    private string GetEmptyTitle()
    {
        return "No Tables Yet";
    }

    private string GetEmptyDescription()
    {
        return "No active games found.";
    }

    private bool CanDeleteTable(GetActiveGamesResponse table)
    {
        return !string.IsNullOrEmpty(_currentUserId) && 
               string.Equals(table.CreatedById, _currentUserId, StringComparison.OrdinalIgnoreCase);
    }

    private async Task HandleDeleteTableAsync(Guid gameId)
    {
        // Find the table to get its name for the confirmation message
        var table = _allTables.FirstOrDefault(t => t.Id == gameId);
        if (table is not null)
        {
            _deleteConfirmationMessage = $"Are you sure you want to delete \"{table.Name}\"? This action cannot be undone.";
        }
        else
        {
            _deleteConfirmationMessage = "Are you sure you want to delete this table? This action cannot be undone.";
        }

        _gameIdToDelete = gameId;
        _showDeleteConfirmation = true;
        await Task.CompletedTask;
    }

    private async Task ConfirmDeleteTableAsync()
    {
        if (_gameIdToDelete is null || _isDeleting)
            return;

        _isDeleting = true;
        try
        {
            var response = await GamesApi.GamesDeleteGameAsync(_gameIdToDelete.Value);
            if (response.IsSuccessStatusCode)
            {
                Logger.LogInformation("Successfully deleted game {GameId}", _gameIdToDelete.Value);
                // The SignalR broadcast will handle removing from the list
            }
            else
            {
                Logger.LogWarning("Failed to delete game {GameId}: {StatusCode}", _gameIdToDelete.Value, response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting game {GameId}", _gameIdToDelete.Value);
        }
        finally
        {
            _isDeleting = false;
            _showDeleteConfirmation = false;
            _gameIdToDelete = null;
        }
    }

    private void CancelDelete()
    {
        _gameIdToDelete = null;
        _showDeleteConfirmation = false;
    }

    public async ValueTask DisposeAsync()
    {
        LobbyHubClient.OnGameCreated -= HandleGameCreatedAsync;
        LobbyHubClient.OnGameDeleted -= HandleGameDeletedAsync;

        try
        {
            await LobbyHubClient.LeaveLobbyAsync();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Error leaving lobby on dispose");
        }
    }
}
