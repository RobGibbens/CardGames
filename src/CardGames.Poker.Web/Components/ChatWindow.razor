@using CardGames.Poker.Shared.DTOs
@using CardGames.Poker.Shared.Enums
@using CardGames.Poker.Shared.Events
@using CardGames.Poker.Web.Services
@inject GameHubService HubService
@inject ChatApiService ChatApi
@implements IDisposable

<div class="chat-window-container card">
    <div class="card-header d-flex justify-content-between align-items-center py-2">
        <h6 class="mb-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-dots me-2" viewBox="0 0 16 16">
                <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
                <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9 9 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.4 10.4 0 0 1-.524 2.318l-.003.011a11 11 0 0 1-.244.637c-.079.186.074.394.273.362a22 22 0 0 0 .693-.125m.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6-3.004 6-7 6a8 8 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a11 11 0 0 0 .398-2"/>
            </svg>
            Table Chat
        </h6>
        <div class="d-flex gap-1">
            @if (ShowMuteControls)
            {
                <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleMuteSettings" title="Mute settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                    </svg>
                </button>
            }
            @if (!_isChatEnabled)
            {
                <span class="badge bg-warning text-dark" title="Chat is disabled">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M6.95.435c.58-.58 1.52-.58 2.1 0l6.515 6.516c.58.58.58 1.519 0 2.098L9.05 15.565c-.58.58-1.519.58-2.098 0L.435 9.05a1.482 1.482 0 0 1 0-2.098L6.95.435zm1.4.7a.495.495 0 0 0-.7 0L1.134 7.65a.495.495 0 0 0 0 .7l6.516 6.516a.495.495 0 0 0 .7 0l6.516-6.516a.495.495 0 0 0 0-.7L8.35 1.134z"/>
                        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
                    </svg>
                    Disabled
                </span>
            }
        </div>
    </div>

    @if (_showMuteSettings)
    {
        <div class="card-body border-bottom py-2">
            <MuteControls TableId="TableId" 
                          CurrentPlayerName="CurrentPlayerName" 
                          Players="@Players"
                          OnMuteChanged="OnMuteListChanged" />
        </div>
    }

    <div class="chat-messages-container card-body p-2" @ref="_messagesContainer">
        @if (_messages.Count == 0)
        {
            <div class="text-center text-muted py-4">
                <small>No messages yet. Start the conversation!</small>
            </div>
        }
        else
        {
            @foreach (var message in _messages)
            {
                @if (!_mutedPlayers.Contains(message.SenderName))
                {
                    <div class="chat-message @GetMessageClass(message) mb-2">
                        @if (message.MessageType == ChatMessageType.System)
                        {
                            <div class="system-message text-center">
                                <small class="text-muted fst-italic">@message.Content</small>
                            </div>
                        }
                        else if (message.MessageType == ChatMessageType.Dealer)
                        {
                            <div class="dealer-message text-center">
                                <small class="text-info">ðŸŽ´ @message.Content</small>
                            </div>
                        }
                        else
                        {
                            <div class="player-message">
                                <div class="d-flex justify-content-between align-items-start">
                                    <strong class="@(message.SenderName == CurrentPlayerName ? "text-primary" : "")">
                                        @message.SenderName
                                    </strong>
                                    <small class="text-muted">@message.Timestamp.ToString("HH:mm")</small>
                                </div>
                                <div class="message-content">@message.Content</div>
                            </div>
                        }
                    </div>
                }
            }
        }
    </div>

    @if (_rejectionMessage is not null)
    {
        <div class="alert alert-warning py-1 px-2 mb-0 mx-2" role="alert">
            <small>@_rejectionMessage</small>
            <button type="button" class="btn-close btn-sm float-end" @onclick="ClearRejectionMessage"></button>
        </div>
    }

    <div class="card-footer py-2">
        @if (_isChatEnabled)
        {
            <div class="input-group input-group-sm">
                <input type="text" 
                       class="form-control" 
                       placeholder="Type a message..." 
                       @bind="_newMessage" 
                       @bind:event="oninput"
                       @onkeypress="HandleKeyPress"
                       maxlength="500"
                       disabled="@_isSending" />
                <button class="btn btn-primary" 
                        type="button" 
                        @onclick="SendMessage"
                        disabled="@(_isSending || string.IsNullOrWhiteSpace(_newMessage))">
                    @if (_isSending)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
                        </svg>
                    }
                </button>
            </div>
            <div class="d-flex justify-content-between mt-1">
                <small class="text-muted">@(_newMessage?.Length ?? 0)/500</small>
            </div>
        }
        else
        {
            <div class="text-center text-muted">
                <small>Chat is currently disabled for this table.</small>
            </div>
        }
    </div>
</div>

<style>
    .chat-window-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 300px;
        max-height: 400px;
    }

    .chat-messages-container {
        flex: 1;
        overflow-y: auto;
        background-color: #f8f9fa;
    }

    .chat-message.player-message {
        background-color: white;
        border-radius: 8px;
        padding: 6px 10px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .chat-message.own-message {
        background-color: #e3f2fd;
    }

    .system-message {
        padding: 4px 0;
    }

    .dealer-message {
        padding: 4px 0;
    }

    .message-content {
        word-wrap: break-word;
        font-size: 0.9rem;
    }
</style>

@code {
    [Parameter]
    public Guid TableId { get; set; }

    [Parameter]
    public string CurrentPlayerName { get; set; } = string.Empty;

    [Parameter]
    public IReadOnlyList<string> Players { get; set; } = Array.Empty<string>();

    [Parameter]
    public bool ShowMuteControls { get; set; } = true;

    [Parameter]
    public int MaxMessages { get; set; } = 100;

    private ElementReference _messagesContainer;
    private readonly List<ChatMessageDto> _messages = new();
    private readonly HashSet<string> _mutedPlayers = new(StringComparer.OrdinalIgnoreCase);
    private string _newMessage = string.Empty;
    private bool _isSending;
    private bool _isChatEnabled = true;
    private string? _rejectionMessage;
    private bool _showMuteSettings;

    protected override void OnInitialized()
    {
        HubService.OnChatMessageReceived += HandleChatMessageReceived;
        HubService.OnChatMessageRejected += HandleChatMessageRejected;
        HubService.OnSystemAnnouncement += HandleSystemAnnouncement;
        HubService.OnTableChatStatusChanged += HandleTableChatStatusChanged;
        HubService.OnPlayerMuted += HandlePlayerMuted;
        HubService.OnPlayerUnmuted += HandlePlayerUnmuted;
    }

    private void HandleChatMessageReceived(ChatMessageSentEvent evt)
    {
        if (evt.TableId != TableId) return;

        InvokeAsync(() =>
        {
            _messages.Add(evt.Message);
            TrimMessages();
            StateHasChanged();
        });
    }

    private void HandleChatMessageRejected(ChatMessageRejectedEvent evt)
    {
        if (evt.TableId != TableId || evt.PlayerName != CurrentPlayerName) return;

        InvokeAsync(() =>
        {
            _rejectionMessage = evt.Reason;
            StateHasChanged();
        });
    }

    private void HandleSystemAnnouncement(SystemAnnouncementEvent evt)
    {
        if (evt.TableId != TableId) return;

        InvokeAsync(() =>
        {
            var message = new ChatMessageDto(
                MessageId: Guid.NewGuid(),
                TableId: evt.TableId,
                SenderName: "System",
                Content: evt.Content,
                MessageType: ChatMessageType.System,
                Timestamp: evt.Timestamp);
            _messages.Add(message);
            TrimMessages();
            StateHasChanged();
        });
    }

    private void HandleTableChatStatusChanged(TableChatStatusChangedEvent evt)
    {
        if (evt.TableId != TableId) return;

        InvokeAsync(() =>
        {
            _isChatEnabled = evt.IsChatEnabled;
            StateHasChanged();
        });
    }

    private void HandlePlayerMuted(PlayerMutedEvent evt)
    {
        if (evt.TableId != TableId || evt.PlayerName != CurrentPlayerName) return;

        InvokeAsync(() =>
        {
            _mutedPlayers.Add(evt.MutedPlayerName);
            StateHasChanged();
        });
    }

    private void HandlePlayerUnmuted(PlayerUnmutedEvent evt)
    {
        if (evt.TableId != TableId || evt.PlayerName != CurrentPlayerName) return;

        InvokeAsync(() =>
        {
            _mutedPlayers.Remove(evt.UnmutedPlayerName);
            StateHasChanged();
        });
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_newMessage) || _isSending) return;

        _isSending = true;
        _rejectionMessage = null;
        var messageContent = _newMessage.Trim();
        _newMessage = string.Empty;

        try
        {
            var response = await ChatApi.SendMessageAsync(TableId, CurrentPlayerName, messageContent);
            
            if (!response.Success)
            {
                _rejectionMessage = response.Error ?? "Failed to send message";
                _newMessage = messageContent; // Restore message so user can retry
            }
            // If successful, the message will be received via SignalR broadcast
        }
        catch
        {
            _rejectionMessage = "Failed to send message. Please try again.";
            _newMessage = messageContent; // Restore message so user can retry
        }
        finally
        {
            _isSending = false;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private void TrimMessages()
    {
        while (_messages.Count > MaxMessages)
        {
            _messages.RemoveAt(0);
        }
    }

    private string GetMessageClass(ChatMessageDto message)
    {
        if (message.MessageType == ChatMessageType.System || message.MessageType == ChatMessageType.Dealer)
            return string.Empty;

        return message.SenderName == CurrentPlayerName ? "player-message own-message" : "player-message";
    }

    private void ClearRejectionMessage()
    {
        _rejectionMessage = null;
    }

    private void ToggleMuteSettings()
    {
        _showMuteSettings = !_showMuteSettings;
    }

    private void OnMuteListChanged(HashSet<string> mutedPlayers)
    {
        _mutedPlayers.Clear();
        foreach (var player in mutedPlayers)
        {
            _mutedPlayers.Add(player);
        }
        StateHasChanged();
    }

    public void Dispose()
    {
        HubService.OnChatMessageReceived -= HandleChatMessageReceived;
        HubService.OnChatMessageRejected -= HandleChatMessageRejected;
        HubService.OnSystemAnnouncement -= HandleSystemAnnouncement;
        HubService.OnTableChatStatusChanged -= HandleTableChatStatusChanged;
        HubService.OnPlayerMuted -= HandlePlayerMuted;
        HubService.OnPlayerUnmuted -= HandlePlayerUnmuted;
    }
}
