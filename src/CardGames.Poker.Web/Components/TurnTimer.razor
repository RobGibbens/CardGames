@using CardGames.Poker.Shared.DTOs
@using CardGames.Poker.Shared.Events

<div class="turn-timer @GetTimerStateClass()">
    <div class="timer-ring">
        <svg viewBox="0 0 100 100" class="timer-svg">
            <circle 
                class="timer-background" 
                cx="50" cy="50" r="45" 
                fill="none" 
                stroke="#333" 
                stroke-width="8" />
            <circle 
                class="timer-progress" 
                cx="50" cy="50" r="45" 
                fill="none" 
                stroke="@GetProgressColor()" 
                stroke-width="8"
                stroke-linecap="round"
                stroke-dasharray="@GetDashArray()"
                stroke-dashoffset="0"
                transform="rotate(-90 50 50)" />
        </svg>
        <div class="timer-text">
            <span class="timer-seconds">@SecondsRemaining</span>
            @if (ShowLabel)
            {
                <span class="timer-label">sec</span>
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(PlayerName))
    {
        <div class="timer-player-name">@PlayerName</div>
    }

    @if (TimeBankRemaining > 0 && ShowTimeBank)
    {
        <button class="time-bank-mini" @onclick="OnTimeBankClickInternal" disabled="@(!CanUseTimeBank)">
            <span class="time-bank-icon">⏱️</span>
            <span class="time-bank-value">@TimeBankRemaining</span>
        </button>
    }
</div>

<style>
    .turn-timer {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .timer-ring {
        position: relative;
        width: 60px;
        height: 60px;
    }

    .timer-svg {
        width: 100%;
        height: 100%;
        transform: scaleX(-1); /* Makes progress go clockwise */
    }

    .timer-background {
        opacity: 0.3;
    }

    .timer-progress {
        transition: stroke-dasharray 0.3s ease, stroke 0.3s ease;
    }

    .timer-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .timer-seconds {
        font-size: 1.5rem;
        font-weight: bold;
        color: white;
        line-height: 1;
    }

    .timer-label {
        font-size: 0.5rem;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
    }

    .timer-player-name {
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.8);
        max-width: 80px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        text-align: center;
    }

    /* State-based styling */
    .turn-timer.normal .timer-progress {
        stroke: #4caf50;
    }

    .turn-timer.warning .timer-progress {
        stroke: #ff9800;
        animation: pulse-warning 0.5s ease-in-out infinite alternate;
    }

    .turn-timer.critical .timer-progress {
        stroke: #f44336;
        animation: pulse-critical 0.3s ease-in-out infinite alternate;
    }

    .turn-timer.expired .timer-progress {
        stroke: #666;
    }

    .turn-timer.time-bank-active .timer-progress {
        stroke: #9c27b0;
        filter: drop-shadow(0 0 6px #9c27b0);
    }

    @@keyframes pulse-warning {
        from { opacity: 1; }
        to { opacity: 0.7; }
    }

    @@keyframes pulse-critical {
        from { opacity: 1; filter: brightness(1); }
        to { opacity: 0.6; filter: brightness(1.3); }
    }

    /* Time bank mini button */
    .time-bank-mini {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border: 1px solid #9c27b0;
        background: rgba(156, 39, 176, 0.2);
        border-radius: 12px;
        color: #ce93d8;
        cursor: pointer;
        font-size: 0.65rem;
        transition: all 0.2s ease;
    }

    .time-bank-mini:hover:not(:disabled) {
        background: rgba(156, 39, 176, 0.4);
        transform: scale(1.05);
    }

    .time-bank-mini:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .time-bank-icon {
        font-size: 0.8rem;
    }

    .time-bank-value {
        font-weight: bold;
    }

    /* Size variations */
    .turn-timer.small .timer-ring {
        width: 40px;
        height: 40px;
    }

    .turn-timer.small .timer-seconds {
        font-size: 1rem;
    }

    .turn-timer.large .timer-ring {
        width: 80px;
        height: 80px;
    }

    .turn-timer.large .timer-seconds {
        font-size: 2rem;
    }
</style>

@code {
    /// <summary>
    /// Current seconds remaining on the timer.
    /// </summary>
    [Parameter]
    public int SecondsRemaining { get; set; }

    /// <summary>
    /// Total duration of the timer in seconds.
    /// </summary>
    [Parameter]
    public int TotalDurationSeconds { get; set; } = 30;

    /// <summary>
    /// Warning threshold in seconds.
    /// </summary>
    [Parameter]
    public int WarningThreshold { get; set; } = 10;

    /// <summary>
    /// Critical threshold in seconds (more urgent than warning).
    /// </summary>
    [Parameter]
    public int CriticalThreshold { get; set; } = 5;

    /// <summary>
    /// The name of the player whose timer this is.
    /// </summary>
    [Parameter]
    public string? PlayerName { get; set; }

    /// <summary>
    /// Remaining time bank seconds for the player.
    /// </summary>
    [Parameter]
    public int TimeBankRemaining { get; set; }

    /// <summary>
    /// Whether the time bank is currently active (has been used this turn).
    /// </summary>
    [Parameter]
    public bool IsTimeBankActive { get; set; }

    /// <summary>
    /// Whether the player can use time bank (their turn, not already used).
    /// </summary>
    [Parameter]
    public bool CanUseTimeBank { get; set; }

    /// <summary>
    /// Whether to show the time bank button.
    /// </summary>
    [Parameter]
    public bool ShowTimeBank { get; set; } = true;

    /// <summary>
    /// Whether to show the "sec" label below the seconds.
    /// </summary>
    [Parameter]
    public bool ShowLabel { get; set; } = true;

    /// <summary>
    /// Timer size: "small", "normal", or "large".
    /// </summary>
    [Parameter]
    public string Size { get; set; } = "normal";

    /// <summary>
    /// Callback when time bank button is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnTimeBankClick { get; set; }

    private string GetTimerStateClass()
    {
        var classes = new List<string>();

        if (Size != "normal")
        {
            classes.Add(Size);
        }

        if (IsTimeBankActive)
        {
            classes.Add("time-bank-active");
        }
        else if (SecondsRemaining <= 0)
        {
            classes.Add("expired");
        }
        else if (SecondsRemaining <= CriticalThreshold)
        {
            classes.Add("critical");
        }
        else if (SecondsRemaining <= WarningThreshold)
        {
            classes.Add("warning");
        }
        else
        {
            classes.Add("normal");
        }

        return string.Join(" ", classes);
    }

    private string GetProgressColor()
    {
        if (IsTimeBankActive)
        {
            return "#9c27b0";
        }
        if (SecondsRemaining <= 0)
        {
            return "#666";
        }
        if (SecondsRemaining <= CriticalThreshold)
        {
            return "#f44336";
        }
        if (SecondsRemaining <= WarningThreshold)
        {
            return "#ff9800";
        }
        return "#4caf50";
    }

    private string GetDashArray()
    {
        // Calculate the circumference
        const double circumference = 2 * Math.PI * 45; // r = 45
        
        // Calculate the progress percentage
        var percentage = TotalDurationSeconds > 0 
            ? (double)SecondsRemaining / TotalDurationSeconds 
            : 0;
        
        // Calculate the dash array
        var progress = circumference * percentage;
        var remaining = circumference - progress;
        
        return $"{progress:F2} {remaining:F2}";
    }

    private async Task OnTimeBankClickInternal()
    {
        if (CanUseTimeBank && OnTimeBankClick.HasDelegate)
        {
            await OnTimeBankClick.InvokeAsync();
        }
    }
}
