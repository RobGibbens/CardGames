## Plan: Standardize Dealing On Dealer (API)

This change standardizes all Poker API dealing so randomness comes only from `FrenchDeckDealer` using `Dealer.Shuffle()` at the start of a hand and `Dealer.DealCard()` (via `DealCards(52)`) to generate a full random deck order without replacement. That random deck order is persisted as `GameCard` rows with `Location = Deck`, and all later dealing (initial deal, streets, draws) consumes the “top” cards from that persisted deck. This removes ad-hoc shuffles (`Random`, `Random.Shared`, Fisher–Yates) and eliminates mid-hand “new deck + random pick” behavior that can break correctness (duplicates, inconsistent state).

**Non-compliant call sites (need refactor)**
- Manual Fisher–Yates / `Random` shuffles:
  - [CardGames.Poker.Api/GameFlow/BaseGameFlowHandler.cs](CardGames.Poker.Api/GameFlow/BaseGameFlowHandler.cs#L352-L410)
  - [CardGames.Poker.Api/Features/Games/KingsAndLows/v1/Commands/StartHand/StartHandCommandHandler.cs](CardGames.Poker.Api/Features/Games/KingsAndLows/v1/Commands/StartHand/StartHandCommandHandler.cs#L350-L418)
- Mid-hand “new random cards” fallback (bypasses deck state):
  - [CardGames.Poker.Api/Features/Games/FiveCardDraw/v1/Commands/ProcessDraw/ProcessDrawCommandHandler.cs](CardGames.Poker.Api/Features/Games/FiveCardDraw/v1/Commands/ProcessDraw/ProcessDrawCommandHandler.cs#L189-L246)
- Flow handlers generating shuffled decks via `CreateShuffledDeck()`:
  - [CardGames.Poker.Api/GameFlow/SevenCardStudFlowHandler.cs](CardGames.Poker.Api/GameFlow/SevenCardStudFlowHandler.cs#L140-L214)
  - [CardGames.Poker.Api/GameFlow/FollowTheQueenFlowHandler.cs](CardGames.Poker.Api/GameFlow/FollowTheQueenFlowHandler.cs#L90-L167)
  - [CardGames.Poker.Api/GameFlow/BaseballFlowHandler.cs](CardGames.Poker.Api/GameFlow/BaseballFlowHandler.cs#L100-L178)

(Handlers that consume `Location = Deck` sequentially become “correct” once the deck order is generated by `FrenchDeckDealer`.)

**Target invariants**
- Every hand has exactly 52 persisted deck cards: `GameCards` where `HandNumber = current`, `Location = Deck`, `GamePlayerId = null`, `DealOrder = 1..52`, unique `(Suit, Symbol)`.
- No code path generates random cards mid-hand; it must always consume from `Location = Deck`.
- Any draw/replacement cards come from the same persisted deck order (top of deck), not from a fresh shuffle or random sampling.

**Steps**
1. Add a single API-layer deck generator helper used everywhere
   - Add a small helper in the API layer (suggested location: [CardGames.Poker.Api/Services](CardGames.Poker.Api/Services) or [CardGames.Poker.Api/Infrastructure](CardGames.Poker.Api/Infrastructure)) with one job:
     - Build a full 52-card deck order using `var dealer = FrenchDeckDealer.WithFullDeck(); dealer.Shuffle(); var cards = dealer.DealCards(52);`
     - Map `CardGames.Core.French.Cards.Suit/Symbol` into `CardGames.Poker.Api.Data.Entities.CardSuit/CardSymbol`.
       - Since enums are compatible (see [CardGames.Poker.Api/Data/Entities/GameCard.cs](CardGames.Poker.Api/Data/Entities/GameCard.cs#L150-L215) and [CardGames.Core.French/Cards/Suit.cs](CardGames.Core.French/Cards/Suit.cs#L1-L9)), you can either cast or keep the existing explicit mapping style used in [CardGames.Poker.Api/Features/Games/SevenCardStud/v1/Commands/StartHand/StartHandCommandHandler.cs](CardGames.Poker.Api/Features/Games/SevenCardStud/v1/Commands/StartHand/StartHandCommandHandler.cs#L170-L260).
   - Output should be a `List<GameCard>` already populated for `Location = Deck`, `GamePlayerId = null`, `IsVisible = false`, and `DealOrder = 1..52`.

2. Replace `CreateShuffledDeck()` so all flow handlers use `FrenchDeckDealer`
   - Update [CardGames.Poker.Api/GameFlow/BaseGameFlowHandler.cs](CardGames.Poker.Api/GameFlow/BaseGameFlowHandler.cs#L352-L410):
     - Remove the `Random.Shared` Fisher–Yates implementation.
     - Re-implement `CreateShuffledDeck()` to return the same `(CardSuit Suit, CardSymbol Symbol)` list, but generated via `FrenchDeckDealer.Shuffle()` + `DealCards(52)` (and mapped into API enums).
   - This automatically fixes all inherited users:
     - [CardGames.Poker.Api/GameFlow/BaseGameFlowHandler.cs](CardGames.Poker.Api/GameFlow/BaseGameFlowHandler.cs#L240-L340)
     - [CardGames.Poker.Api/GameFlow/SevenCardStudFlowHandler.cs](CardGames.Poker.Api/GameFlow/SevenCardStudFlowHandler.cs#L140-L214)
     - [CardGames.Poker.Api/GameFlow/FollowTheQueenFlowHandler.cs](CardGames.Poker.Api/GameFlow/FollowTheQueenFlowHandler.cs#L90-L167)
     - [CardGames.Poker.Api/GameFlow/BaseballFlowHandler.cs](CardGames.Poker.Api/GameFlow/BaseballFlowHandler.cs#L100-L178)
   - Decide and document `DealOrder` base (prefer 1-based to match entity docs in [CardGames.Poker.Api/Data/Entities/GameCard.cs](CardGames.Poker.Api/Data/Entities/GameCard.cs#L70-L88)); keep it consistent across flow handlers.

3. Refactor Kings and Lows `StartHand` to persist a Dealer-generated deck (and deal from it)
   - Update [CardGames.Poker.Api/Features/Games/KingsAndLows/v1/Commands/StartHand/StartHandCommandHandler.cs](CardGames.Poker.Api/Features/Games/KingsAndLows/v1/Commands/StartHand/StartHandCommandHandler.cs#L320-L418):
     - Replace “build all 52 + Fisher–Yates shuffle” with the shared deck generator (or an inline `FrenchDeckDealer` usage consistent with other StartHand handlers like [CardGames.Poker.Api/Features/Games/Baseball/v1/Commands/StartHand/StartHandCommandHandler.cs](CardGames.Poker.Api/Features/Games/Baseball/v1/Commands/StartHand/StartHandCommandHandler.cs#L110-L200)).
     - Persist all 52 as `Location = Deck`.
     - Deal to players by consuming from the persisted deck order (move cards from `Deck` to `Hand` and set `GamePlayerId`).
   - Keep the existing “sort each player’s cards for display” logic, but ensure it only touches cards already moved out of `Location = Deck` (so the remaining deck order stays intact for draws).

4. Fix Five Card Draw draw/replacement logic so it never “creates random cards”
   - In [CardGames.Poker.Api/Features/Games/FiveCardDraw/v1/Commands/ProcessDraw/ProcessDrawCommandHandler.cs](CardGames.Poker.Api/Features/Games/FiveCardDraw/v1/Commands/ProcessDraw/ProcessDrawCommandHandler.cs#L189-L246):
     - Remove the fallback path that creates a new `FullFrenchDeck` and does `OrderBy(_ => rng.Next())`.
     - Replace it with a strict invariant: replacement cards must come from `GameCards` where `Location = Deck` for the current hand (same approach already used earlier in the method at [CardGames.Poker.Api/Features/Games/FiveCardDraw/v1/Commands/ProcessDraw/ProcessDrawCommandHandler.cs](CardGames.Poker.Api/Features/Games/FiveCardDraw/v1/Commands/ProcessDraw/ProcessDrawCommandHandler.cs#L160-L188)).
     - If there aren’t enough deck cards available, return a domain error (not an exception) indicating inconsistent deck state.
   - Ensure the initial dealing path always persists the deck for FiveCardDraw hands:
     - That comes from the GameFlow dealing logic in [CardGames.Poker.Api/GameFlow/BaseGameFlowHandler.cs](CardGames.Poker.Api/GameFlow/BaseGameFlowHandler.cs#L240-L340); once `CreateShuffledDeck()` is Dealer-backed, the deck will always be present when the game reaches draw.

5. Standardize “consume top-of-deck” patterns (optional cleanup, keep behavior)
   - Many handlers currently do `deckCards[i]` or `deckCards[deckIndex++]` after ordering by `DealOrder`. This is OK under Strategy A as long as:
     - The deck order was generated via `FrenchDeckDealer`, and
     - Cards are moved out of `Location = Deck` when dealt, so subsequent consumes don’t re-use them.
   - If you want extra safety, introduce a small helper method (API layer) like “get next N deck cards for a hand” that always queries `Location = Deck` ordered by `DealOrder`, and use it in:
     - Kings and Lows draw logic: [CardGames.Poker.Api/Features/Games/KingsAndLows/v1/Commands/DrawCards/DrawCardsCommandHandler.cs](CardGames.Poker.Api/Features/Games/KingsAndLows/v1/Commands/DrawCards/DrawCardsCommandHandler.cs#L180-L240)
     - Kings and Lows deck-draw logic (similar pattern): [CardGames.Poker.Api/Features/Games/KingsAndLows/v1/Commands/DeckDraw/DeckDrawCommandHandler.cs](CardGames.Poker.Api/Features/Games/KingsAndLows/v1/Commands/DeckDraw/DeckDrawCommandHandler.cs)
     - Street runouts that currently index into a sorted deck list.

6. Repo-wide verification sweep (to ensure “all places” are fixed)
   - After refactors, confirm no ad-hoc RNG remains in API dealing by searching in `CardGames.Poker.Api` for:
     - `Fisher-Yates`, `new Random(`, `Random.Shared`, `OrderBy(_ => rng.Next())`, and `CreateShuffledDeck(`.
   - Confirm any remaining matches are unrelated to dealing, or are tests only.

**Verification**
- Build: run the existing solution build task (`dotnet build` for CardGames.sln).
- Automated checks:
  - Run the integration tests that cover game flow and draw behavior (the repo already has test suites listed in the earlier scan; update expectations where deck ordering or error handling changes).
- Manual/API sanity:
  - Start a FiveCardDraw hand, discard 1–3 cards, and verify replacements come from the persisted deck (deck count decreases, no duplicates).
  - Start a KingsAndLows hand and verify 52 `Location = Deck` cards exist and no `Random` shuffle code runs.

**Decisions**
- Strategy: Persist full deck order per hand generated via `FrenchDeckDealer` (randomness at hand start; deterministic consumption mid-hand).
- Scope: API only (`CardGames.Poker.Api`).
- RNG: Standardize on existing `Dealer` RNG behavior; no new RNG injection in this change.
